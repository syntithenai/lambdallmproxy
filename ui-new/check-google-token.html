<!DOCTYPE html>
<html>
<head>
  <title>Google Token Checker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover { background: #357ae8; }
    .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .success { color: #388e3c; background: #e8f5e9; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .info { color: #1976d2; background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; }
    .token-info { margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Google OAuth Token Checker</h1>
    <p>This tool helps diagnose OAuth token issues with the snippet sync feature.</p>
    
    <div id="results"></div>
    
    <button onclick="checkTokens()">Check Current Tokens</button>
    <button onclick="testSheetsAccess()">Test Google Sheets Access</button>
    <button onclick="clearTokens()">Clear All Tokens</button>
    <button onclick="window.location.href='http://localhost:8082'">Go to App</button>
  </div>

  <script>
    function displayResult(type, message) {
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = message;
      document.getElementById('results').appendChild(div);
    }

    function checkTokens() {
      document.getElementById('results').innerHTML = '';
      
      const tokenKeys = [
        'google_access_token',
        'google_drive_access_token', 
        'gapi_access_token'
      ];
      
      let foundAny = false;
      
      tokenKeys.forEach(key => {
        const token = localStorage.getItem(key);
        if (token) {
          foundAny = true;
          displayResult('success', `
            <strong>‚úì Found: ${key}</strong><br>
            Length: ${token.length} characters<br>
            First 50 chars: <code>${token.substring(0, 50)}...</code><br>
            <button onclick="copyToken('${key}')">Copy Full Token</button>
          `);
          
          // Try to decode JWT to check expiration
          try {
            const parts = token.split('.');
            if (parts.length === 3) {
              const payload = JSON.parse(atob(parts[1]));
              if (payload.exp) {
                const expDate = new Date(payload.exp * 1000);
                const now = new Date();
                const expired = expDate < now;
                
                displayResult(expired ? 'error' : 'success', `
                  Token expiration: ${expDate.toLocaleString()}<br>
                  Status: ${expired ? '‚ùå EXPIRED' : '‚úÖ Valid'}
                `);
              }
            }
          } catch (e) {
            displayResult('info', 'Token is not a JWT (might be an OAuth2 token - this is normal)');
          }
        }
      });
      
      if (!foundAny) {
        displayResult('error', '‚ùå No Google OAuth tokens found in localStorage. You need to authenticate first.');
      }
      
      // Check cloud sync settings
      const configSync = localStorage.getItem('cloud_sync_config');
      const swagSync = localStorage.getItem('cloud_sync_swag');
      displayResult('info', `
        <strong>Cloud Sync Settings:</strong><br>
        Config Sync: ${configSync || 'not set'}<br>
        Swag Sync: ${swagSync || 'not set'}
      `);
    }
    
    async function testSheetsAccess() {
      document.getElementById('results').innerHTML = '';
      
      const token = localStorage.getItem('google_access_token') || 
                    localStorage.getItem('gapi_access_token') ||
                    localStorage.getItem('google_drive_access_token');
      
      if (!token) {
        displayResult('error', '‚ùå No token found. Please authenticate first.');
        return;
      }
      
      displayResult('info', 'üîÑ Testing Google Sheets API access...');
      
      try {
        // Test with Google Sheets API - try to list spreadsheets
        const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets?fields=spreadsheetId,properties', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          displayResult('success', `
            ‚úÖ Token is valid! Google Sheets API access working.<br>
            <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
          `);
        } else {
          const error = await response.text();
          displayResult('error', `
            ‚ùå Google Sheets API returned error (${response.status}):<br>
            <pre>${error}</pre><br>
            <strong>This is your problem!</strong> The token is expired or doesn't have the right scopes.<br>
            <strong>Solution:</strong> Go to Settings ‚Üí Cloud Sync and reconnect your Google account.
          `);
        }
      } catch (err) {
        displayResult('error', `
          ‚ùå Network error testing API:<br>
          ${err.message}
        `);
      }
    }
    
    function copyToken(key) {
      const token = localStorage.getItem(key);
      navigator.clipboard.writeText(token).then(() => {
        alert('Token copied to clipboard!');
      });
    }
    
    function clearTokens() {
      if (!confirm('Clear all Google OAuth tokens? You will need to re-authenticate.')) {
        return;
      }
      
      localStorage.removeItem('google_access_token');
      localStorage.removeItem('google_drive_access_token');
      localStorage.removeItem('gapi_access_token');
      localStorage.removeItem('cloud_sync_config');
      localStorage.removeItem('cloud_sync_swag');
      
      displayResult('success', '‚úÖ All tokens cleared! Please reload the app and re-authenticate.');
    }
    
    // Auto-run check on load
    window.addEventListener('load', checkTokens);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Refresh Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Google Token Refresh Test</h1>
    
    <div id="status" class="status">Initializing...</div>
    
    <div>
        <button onclick="testTokenValidation()">Test Token Validation</button>
        <button onclick="testTokenRefresh()">Test Token Refresh</button>
        <button onclick="simulateExpiredToken()">Simulate Expired Token</button>
        <button onclick="clearTokens()">Clear All Tokens</button>
    </div>
    
    <div>
        <h3>Token Information:</h3>
        <pre id="tokenInfo">Loading...</pre>
    </div>
    
    <div>
        <h3>Test Log:</h3>
        <div id="log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function updateTokenInfo() {
            const tokenInfo = document.getElementById('tokenInfo');
            const token = localStorage.getItem('google_access_token');
            const user = localStorage.getItem('google_user');
            const refreshToken = localStorage.getItem('google_refresh_token');
            const lastRefresh = localStorage.getItem('last_token_refresh');
            
            let info = '';
            if (token) {
                try {
                    // Try to parse as JWT
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        const remaining = Math.max(0, exp.getTime() - now.getTime());
                        
                        info += `Token Type: JWT (ID Token)\n`;
                        info += `Expires: ${exp.toLocaleString()}\n`;
                        info += `Time Remaining: ${Math.floor(remaining / 1000 / 60)} minutes\n`;
                        info += `Valid: ${remaining > 0 ? 'Yes' : 'No'}\n`;
                        info += `Needs Refresh: ${remaining < 10 * 60 * 1000 ? 'Yes' : 'No'}\n`;
                    } else {
                        info += `Token Type: Access Token (${token.length} chars)\n`;
                    }
                } catch (e) {
                    info += `Token Type: Unknown (${token.length} chars)\n`;
                }
            } else {
                info += `No token found\n`;
            }
            
            if (user) {
                const userObj = JSON.parse(user);
                info += `User: ${userObj.email}\n`;
            }
            
            info += `Refresh Token: ${refreshToken ? 'Present' : 'None'}\n`;
            info += `Last Refresh: ${lastRefresh ? new Date(parseInt(lastRefresh)).toLocaleString() : 'Never'}\n`;
            
            tokenInfo.textContent = info;
        }
        
        function testTokenValidation() {
            log('Testing token validation...');
            const token = localStorage.getItem('google_access_token');
            
            if (!token) {
                log('❌ No token found');
                updateStatus('No token to validate', 'error');
                return;
            }
            
            // Basic validation
            let isValid = false;
            try {
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                    const exp = payload.exp;
                    const now = Math.floor(Date.now() / 1000);
                    isValid = exp > now;
                    
                    log(`Token expires at: ${new Date(exp * 1000).toLocaleString()}`);
                    log(`Current time: ${new Date().toLocaleString()}`);
                    log(`Time remaining: ${Math.max(0, exp - now)} seconds`);
                }
            } catch (e) {
                log(`❌ Error parsing token: ${e.message}`);
            }
            
            log(`✅ Token is ${isValid ? 'valid' : 'expired'}`);
            updateStatus(`Token is ${isValid ? 'valid' : 'expired'}`, isValid ? 'success' : 'error');
            updateTokenInfo();
        }
        
        async function testTokenRefresh() {
            log('Testing token refresh...');
            
            // This would normally call the refresh function from auth.js
            log('⚠️ Token refresh requires the actual auth.js functions');
            log('In real implementation, this would call refreshGoogleToken()');
            
            updateStatus('Token refresh test completed (requires auth.js)', 'warning');
        }
        
        function simulateExpiredToken() {
            log('Simulating expired token...');
            
            // Create a fake expired JWT token
            const header = btoa(JSON.stringify({alg: 'RS256', typ: 'JWT'}));
            const payload = btoa(JSON.stringify({
                email: 'test@example.com',
                name: 'Test User',
                exp: Math.floor(Date.now() / 1000) - 3600 // Expired 1 hour ago
            }));
            const signature = 'fake_signature';
            
            const expiredToken = `${header}.${payload}.${signature}`;
            localStorage.setItem('google_access_token', expiredToken);
            localStorage.setItem('google_user', JSON.stringify({
                email: 'test@example.com',
                name: 'Test User',
                picture: 'https://via.placeholder.com/32'
            }));
            
            log('✅ Created fake expired token');
            updateStatus('Simulated expired token created', 'warning');
            updateTokenInfo();
        }
        
        function clearTokens() {
            log('Clearing all tokens...');
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_refresh_token');
            localStorage.removeItem('google_user');
            localStorage.removeItem('last_token_refresh');
            
            log('✅ All tokens cleared');
            updateStatus('All tokens cleared', 'success');
            updateTokenInfo();
        }
        
        // Initialize
        log('Token refresh test page loaded');
        updateTokenInfo();
        updateStatus('Ready for testing', 'success');
        
        // Update token info every 5 seconds
        setInterval(updateTokenInfo, 5000);
    </script>
</body>
</html>
# Tool Calling Improvements

**Date**: 2025-10-05  
**Issue**: LLM not using tools even when appropriate (e.g., "Find current news about climate change")  
**Response**: "I can search for the latest news..." (no actual search performed)  
**Status**: ✅ Fixed

## Problem Description

User asked: **"Find current news about climate change policy updates"**

LLM responded: **"I can search for the latest news on climate change policy updates."**

But the LLM did NOT actually use the `search_web` tool, even though:
- Web search tool was enabled by default
- The query clearly needed real-time web information
- The tool was available in the tools array

## Root Cause

The system prompt had been optimized to prevent the LLM from writing XML-style function syntax (like `<function=search>`), but the warnings were **too strong** and discouraged tool use altogether:

**Previous Prompt**:
```
You have access to the following tools: search_web. Use them when appropriate...

CRITICAL: Do NOT include ANY XML-style tags or function syntax in your text responses. 
NEVER write <function=search>, <function=search_web>, <function=execute_javascript>, 
or ANY similar syntax...
```

This made the LLM **overly cautious** about using tools at all, thinking it might violate the "NEVER" rules.

Additionally:
- Tool descriptions were generic and not compelling
- Default parameters (`load_content: false`, `generate_summary: false`) produced poor results
- No clear examples of when to use tools

## The Solution

### 1. Improved System Prompt (More Encouraging)

**New Prompt**:
```
You have access to these tools: search_web.

IMPORTANT: When users ask for current information, news, web content, or anything 
requiring real-time data or external sources, you MUST use the appropriate tools. 
Do not make up information or refuse to help - use the tools to get accurate, 
up-to-date information.

Examples when you MUST use tools:
- "Find current news about X" → Use search_web
- "What's the latest on X" → Use search_web  
- "Search for X" → Use search_web
- "Get content from URL" → Use scrape_web_content
- "Execute this code" → Use execute_javascript

Tool calls are made automatically through the API using OpenAI function calling format. 
Just invoke the tool when needed - do NOT write XML-style tags like <function=search> 
or similar syntax in your text responses. Your responses should be natural language only.
```

**Key Changes**:
- ✅ Changed "CRITICAL: Do NOT" to positive "IMPORTANT: MUST use"
- ✅ Added explicit examples with arrow notation showing when to use tools
- ✅ Emphasized "MUST use" and "Do not make up information"
- ✅ Still prevents XML syntax but doesn't make it the primary focus
- ✅ Tone is instructive rather than restrictive

### 2. Improved Tool Description

**Before**:
```javascript
description: 'Search the web for results relevant to a query and optionally generate an LLM summary.'
```

**After**:
```javascript
description: 'Search the web using DuckDuckGo to find current information, news, articles, and real-time data. USE THIS whenever users ask for current/latest information, news, or anything requiring up-to-date web content. Returns search results with titles, URLs, and snippets.'
```

**Key Changes**:
- ✅ More specific about what it does (DuckDuckGo, current info, news)
- ✅ Explicit instruction: "USE THIS whenever users ask for current/latest information"
- ✅ Clear return value description

### 3. Better Default Parameters

**Before**:
```javascript
{
  limit: { default: 3 },              // Only 3 results
  load_content: { default: false },   // Don't fetch full content
  generate_summary: { default: false } // Don't summarize
}
```

**After**:
```javascript
{
  limit: { default: 5, description: 'Number of results to return (default: 5)' },
  load_content: { default: true, description: 'Fetch full page content for each result (recommended for better answers)' },
  generate_summary: { default: true, description: 'Generate an LLM summary of the search results (highly recommended)' }
}
```

**Benefits**:
- ✅ More results (5 instead of 3)
- ✅ Full content fetched by default → Better context for answers
- ✅ Summary generated by default → More useful responses
- ✅ Descriptions guide the LLM to use better parameters

## Changes Made

### File: `ui-new/src/components/ChatTab.tsx`

**Lines 211-224** - System Prompt:
```tsx
// Before
finalSystemPrompt += `\n\nYou have access to the following tools: ${toolNames}. Use them when appropriate to provide better answers. For web searches, scraping, or code execution, use the relevant tools.\n\nCRITICAL: Do NOT include ANY XML-style tags...`;

// After
finalSystemPrompt += `\n\nYou have access to these tools: ${toolNames}.

IMPORTANT: When users ask for current information, news, web content, or anything requiring real-time data or external sources, you MUST use the appropriate tools. Do not make up information or refuse to help - use the tools to get accurate, up-to-date information.

Examples when you MUST use tools:
- "Find current news about X" → Use search_web
- "What's the latest on X" → Use search_web  
- "Search for X" → Use search_web
- "Get content from URL" → Use scrape_web_content
- "Execute this code" → Use execute_javascript

Tool calls are made automatically through the API using OpenAI function calling format. Just invoke the tool when needed - do NOT write XML-style tags like <function=search> or similar syntax in your text responses. Your responses should be natural language only.`;
```

**Lines 102-121** - Tool Definition:
```tsx
// Before
{
  name: 'search_web',
  description: 'Search the web for results relevant to a query and optionally generate an LLM summary.',
  parameters: {
    properties: {
      query: { type: 'string', description: 'Search query' },
      limit: { type: 'integer', minimum: 1, maximum: 50, default: 3 },
      load_content: { type: 'boolean', default: false, description: 'Fetch full page content for each result'},
      generate_summary: { type: 'boolean', default: false, description: 'Generate an LLM summary of results'}
    }
  }
}

// After
{
  name: 'search_web',
  description: 'Search the web using DuckDuckGo to find current information, news, articles, and real-time data. USE THIS whenever users ask for current/latest information, news, or anything requiring up-to-date web content. Returns search results with titles, URLs, and snippets.',
  parameters: {
    properties: {
      query: { type: 'string', description: 'Search query - be specific and include relevant keywords' },
      limit: { type: 'integer', minimum: 1, maximum: 50, default: 5, description: 'Number of results to return (default: 5)' },
      load_content: { type: 'boolean', default: true, description: 'Fetch full page content for each result (recommended for better answers)'},
      generate_summary: { type: 'boolean', default: true, description: 'Generate an LLM summary of the search results (highly recommended)'}
    }
  }
}
```

## Build Status

**Frontend Build**:
```bash
cd ui-new && npm run build
# Output: 249.43 kB (gzip: 75.85 kB)
# File: docs/assets/index-DYdIGzv3.js
# Status: ✅ Built successfully
```

## Expected Behavior Now

When user asks: **"Find current news about climate change policy updates"**

The LLM should:
1. ✅ Recognize this needs current information
2. ✅ Invoke `search_web` tool with query: "climate change policy updates news"
3. ✅ Use default parameters: `limit: 5`, `load_content: true`, `generate_summary: true`
4. ✅ Wait for search results
5. ✅ Receive search results + summary
6. ✅ Provide a comprehensive answer based on actual web content

Instead of:
- ❌ "I can search for..." (without actually searching)
- ❌ Making up outdated information
- ❌ Refusing to help

## Testing Scenarios

### Test 1: Current News Query
**User**: "Find current news about climate change policy updates"
**Expected**: Tool call → search_web → Results with actual news

### Test 2: Latest Information
**User**: "What's the latest on AI regulations?"
**Expected**: Tool call → search_web → Current articles

### Test 3: Specific Search
**User**: "Search for recent studies on renewable energy"
**Expected**: Tool call → search_web → Recent studies

### Test 4: General Knowledge (Should NOT use tool)
**User**: "Explain photosynthesis"
**Expected**: Direct answer (no tool call needed)

## Key Lessons

1. **Positive Instructions > Negative Warnings**: "MUST use tools" works better than "NEVER do this"
2. **Examples Matter**: Showing concrete examples (with arrows) helps LLM pattern match
3. **Tool Descriptions Should Sell**: Make it clear WHEN and WHY to use the tool
4. **Smart Defaults**: Choose defaults that produce the best user experience
5. **Balance**: Prevent bad behavior (XML syntax) without discouraging good behavior (tool use)

## Summary

**Fixed LLM tool calling** by making the system prompt more encouraging and instructive rather than restrictive, improving tool descriptions to be more compelling, and setting better default parameters for search quality.

**Result**: 
- ✅ LLM now uses tools when appropriate
- ✅ Better search results (more items, full content, summaries)
- ✅ Still prevents XML syntax issues
- ✅ More helpful responses with actual data

**Status**: ✅ Ready for testing

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit security checks
echo "üîí Running pre-commit security checks..."

# Run lint-staged (ESLint + secret detection)
npx lint-staged

# Additional secret scan (excluding config files and tests)
echo "üîç Scanning for hard-coded secrets..."
FILES_TO_SCAN=$(git diff --cached --name-only | grep -v -E '\.(md|yml|yaml|config\.js|env)$|test\.js$|tests/' || true)
if [ -n "$FILES_TO_SCAN" ]; then
  if echo "$FILES_TO_SCAN" | xargs grep -lE "sk-[a-zA-Z0-9]{20,}|gsk_[a-zA-Z0-9]{32,}|AIza[a-zA-Z0-9]{35}|AKIA[A-Z0-9]{16}|ya29\.[a-zA-Z0-9_-]+" 2>/dev/null; then
    echo "‚ùå ERROR: Hard-coded secret detected in staged files!"
    echo "Please remove secrets and use environment variables instead."
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  No source files to scan (only config/docs/tests changed)"
fi

# Check for console.log in production code (warning only)
if git diff --cached --name-only | grep -E 'src/.*\.js$' | xargs grep -n "console\.log" 2>/dev/null; then
  echo "‚ö†Ô∏è  WARNING: console.log detected in production code"
  echo "Consider using proper logging or removing debug statements"
  # Don't exit - this is just a warning
fi

echo "‚úÖ Pre-commit checks passed!"

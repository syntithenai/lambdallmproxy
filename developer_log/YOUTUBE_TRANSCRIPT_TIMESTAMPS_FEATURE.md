# YouTube Transcript Timestamps and Metadata Feature

**Date**: 2025-10-11  
**Status**: ‚úÖ DEPLOYED  
**Priority**: ENHANCEMENT (User Request)

## Overview

Added a new `get_youtube_transcript` tool that provides detailed YouTube transcripts with:
- ‚è±Ô∏è **Timestamps** for each caption segment
- üåç **Language information** (language code, name, auto-generated status)
- üìä **Metadata** (duration, segment count, character count)
- üéØ **Structured data** format for easy parsing

## User Request

> "i see the transcripts, can i get timestamps and other info about the transcript (language)"

## What's New

### New Tool: `get_youtube_transcript`

**When to use**:
- User wants timestamps: "get transcript with timestamps"
- User wants to know video language: "what language is this video in?"
- User wants structured transcript data
- User needs to reference specific times in video

**vs. existing tools**:
- `search_youtube`: For finding videos (includes 500-char transcript preview)
- `transcribe_url`: For Whisper transcription (no timestamps, uses audio processing)
- `get_youtube_transcript`: For detailed caption data (timestamps, language, segments)

### Enhanced `youtube-api.js` Module

**New function signature**:
```javascript
getYouTubeTranscript(url, accessToken, options)
```

**Options**:
- `includeTimestamps` (boolean, default: true): Return structured data with timestamps
- `language` (string, default: 'en'): Preferred language code

**Return formats**:

**With timestamps** (`includeTimestamps: true`):
```json
{
  "text": "Full transcript as plain text...",
  "segments": [
    {
      "index": 1,
      "start": 0.5,
      "end": 3.2,
      "startTime": "00:00:00",
      "endTime": "00:00:03",
      "duration": 2.7,
      "text": "First caption segment"
    },
    ...
  ],
  "metadata": {
    "videoId": "abc123",
    "language": "en",
    "languageName": "English",
    "trackKind": "ASR",
    "isAutoGenerated": true,
    "segmentCount": 150,
    "totalCharacters": 8234,
    "duration": 342.5
  }
}
```

**Without timestamps** (`includeTimestamps: false`):
```json
"Full transcript as plain text..."
```

## Technical Implementation

### Files Changed

#### 1. `src/youtube-api.js`

**Enhanced `getYouTubeTranscript` function**:
```diff
-async function getYouTubeTranscript(url, accessToken)
+async function getYouTubeTranscript(url, accessToken, options = {})
```

- Added `options` parameter with `includeTimestamps` and `language`
- Returns structured data when `includeTimestamps: true`
- Returns plain text when `includeTimestamps: false` (backward compatible)

**New function: `parseSrtToSegments`**:
- Parses SRT (SubRip) format into structured segments
- Extracts timing information (start, end, duration)
- Formats timestamps as HH:MM:SS
- Converts time to seconds (float) for calculations
- Cleans HTML entities and tags from text

**Updated `parseSrtToText`**:
- Now uses `parseSrtToSegments` internally
- Simplified to join segment texts
- More maintainable code

**Metadata extraction**:
- Video ID
- Language code (e.g., "en", "es")
- Language name (e.g., "English", "Spanish")
- Track kind ("standard" or "ASR")
- Is auto-generated boolean
- Segment count
- Total character count
- Video duration

#### 2. `src/tools.js`

**New tool definition**:
```javascript
{
  type: 'function',
  function: {
    name: 'get_youtube_transcript',
    description: 'üìù Get detailed YouTube video transcript with timestamps and metadata...',
    parameters: {
      url: 'YouTube video URL',
      include_timestamps: 'boolean (default: true)',
      language: 'string (default: "en")'
    }
  }
}
```

**New case handler**:
- Validates YouTube URL
- Checks for OAuth token
- Calls `getYouTubeTranscript` with options
- Returns structured JSON response
- Provides helpful error messages

**Error handling**:
- No OAuth token ‚Üí Suggest login or use transcribe_url
- Invalid URL ‚Üí Explain supported formats
- 403/401 errors ‚Üí Suggest re-authentication
- No captions ‚Üí Suggest transcribe_url alternative

## Usage Examples

### Example 1: Get transcript with timestamps

**User**: "get the transcript of this video with timestamps: https://www.youtube.com/watch?v=abc123"

**Tool call**:
```json
{
  "name": "get_youtube_transcript",
  "arguments": {
    "url": "https://www.youtube.com/watch?v=abc123",
    "include_timestamps": true
  }
}
```

**Response**:
```json
{
  "success": true,
  "url": "https://www.youtube.com/watch?v=abc123",
  "videoId": "abc123",
  "text": "Full transcript...",
  "segments": [
    {
      "index": 1,
      "start": 0.0,
      "end": 2.5,
      "startTime": "00:00:00",
      "endTime": "00:00:02",
      "duration": 2.5,
      "text": "Welcome to this video"
    },
    {
      "index": 2,
      "start": 2.5,
      "end": 5.8,
      "startTime": "00:00:02",
      "endTime": "00:00:05",
      "duration": 3.3,
      "text": "Today we'll learn about AI"
    }
  ],
  "metadata": {
    "videoId": "abc123",
    "language": "en",
    "languageName": "English",
    "trackKind": "ASR",
    "isAutoGenerated": true,
    "segmentCount": 2,
    "totalCharacters": 48,
    "duration": 5.8
  }
}
```

### Example 2: Get transcript in specific language

**User**: "get the Spanish transcript for this video"

**Tool call**:
```json
{
  "name": "get_youtube_transcript",
  "arguments": {
    "url": "https://www.youtube.com/watch?v=xyz789",
    "language": "es"
  }
}
```

### Example 3: Get plain text (no timestamps)

**User**: "what does this video say? just give me the text"

**Tool call**:
```json
{
  "name": "get_youtube_transcript",
  "arguments": {
    "url": "https://www.youtube.com/watch?v=def456",
    "include_timestamps": false
  }
}
```

**Response**:
```json
{
  "success": true,
  "url": "https://www.youtube.com/watch?v=def456",
  "videoId": "def456",
  "text": "Full transcript as plain text without timestamps...",
  "metadata": {
    "totalCharacters": 8234,
    "format": "plain_text"
  }
}
```

### Example 4: Find specific timestamp

**User**: "what was said at 1 minute 30 seconds in this video?"

**LLM workflow**:
1. Call `get_youtube_transcript` with `include_timestamps: true`
2. Find segment where `start <= 90 <= end` (90 seconds = 1:30)
3. Return the text from that segment

## Segment Data Structure

Each segment includes:

| Field | Type | Example | Description |
|-------|------|---------|-------------|
| `index` | integer | `42` | Sequence number from SRT file |
| `start` | float | `90.5` | Start time in seconds |
| `end` | float | `93.2` | End time in seconds |
| `startTime` | string | `"00:01:30"` | Formatted start time (HH:MM:SS) |
| `endTime` | string | `"00:01:33"` | Formatted end time (HH:MM:SS) |
| `duration` | float | `2.7` | Duration in seconds |
| `text` | string | `"This is the caption"` | Caption text (cleaned) |

## Metadata Fields

| Field | Type | Example | Description |
|-------|------|---------|-------------|
| `videoId` | string | `"abc123"` | YouTube video ID |
| `language` | string | `"en"` | Language code (ISO 639-1) |
| `languageName` | string | `"English"` | Human-readable language name |
| `trackKind` | string | `"ASR"` | "standard" (manual) or "ASR" (auto-generated) |
| `isAutoGenerated` | boolean | `true` | Whether captions are auto-generated |
| `segmentCount` | integer | `150` | Number of caption segments |
| `totalCharacters` | integer | `8234` | Total characters in transcript |
| `duration` | float | `342.5` | Video duration in seconds |

## SRT Format Parsing

The YouTube Captions API returns transcripts in SRT (SubRip) format:

```srt
1
00:00:00,500 --> 00:00:03,200
Welcome to this video

2
00:00:03,200 --> 00:00:07,100
Today we'll learn about AI

3
00:00:07,100 --> 00:00:12,500
Let's get started with the basics
```

**Parsing logic**:
1. Split by double newlines (blank lines separate segments)
2. Extract sequence number (line 1)
3. Parse timing line (line 2) with regex
4. Collect text lines (line 3+)
5. Clean HTML entities and tags
6. Convert timestamps to seconds and formatted strings

## Backward Compatibility

**Existing code continues to work**:
```javascript
// Old way (still works, returns plain text)
const transcript = await getYouTubeTranscript(url, token);

// New way (get structured data)
const data = await getYouTubeTranscript(url, token, { includeTimestamps: true });
```

**Default behavior**:
- If no options provided: Returns plain text (backward compatible)
- If `includeTimestamps: true`: Returns structured data
- If `includeTimestamps: false`: Returns plain text

## Tool Comparison

| Feature | search_youtube | get_youtube_transcript | transcribe_url |
|---------|---------------|----------------------|----------------|
| **Purpose** | Find videos | Get detailed captions | Transcribe audio |
| **Timestamps** | ‚ùå No | ‚úÖ Yes | ‚ùå No |
| **Language info** | ‚ö†Ô∏è Limited | ‚úÖ Full metadata | ‚ö†Ô∏è Detect only |
| **Requires OAuth** | ‚ö†Ô∏è Optional | ‚úÖ Yes | ‚ùå No |
| **Transcript length** | 500 chars | ‚úÖ Full | ‚úÖ Full |
| **Method** | YouTube Captions API | YouTube Captions API | Whisper API |
| **Cost** | Free | Free | OpenAI API cost |
| **Speed** | Fast | Fast | Slow (downloads audio) |
| **Works offline videos** | ‚ùå No | ‚ùå No | ‚úÖ Yes |

## When to Use Each Tool

### Use `search_youtube` when:
- User wants to find videos on a topic
- Need video titles, descriptions, thumbnails
- Want quick preview of transcript (500 chars)
- Building a playlist or collection

### Use `get_youtube_transcript` when:
- User explicitly asks for timestamps
- Need to reference specific times
- Want language/metadata information
- Need structured data for analysis
- Creating subtitles or captions file

### Use `transcribe_url` when:
- Video has no captions
- User not authenticated with YouTube
- Need transcription of non-YouTube media
- Video is private/unlisted (no captions API access)
- Want Whisper's higher accuracy

## Requirements

**For `get_youtube_transcript`**:
- ‚úÖ User must be logged in with Google OAuth
- ‚úÖ YouTube enabled in settings
- ‚úÖ OAuth scope: `youtube.force-ssl`
- ‚úÖ Video must have captions/subtitles available
- ‚ùå Does not work for private videos (API limitation)

## Deployment

**Package size**: 178K (up from 176K, +2K for enhanced logic)  
**Deployment time**: ~8 seconds  
**Commit**: TBD  
**Status**: Deployed to Lambda ‚úÖ

```bash
make deploy-lambda-fast
# Package created and uploaded
# Function: Active
```

## Testing

### Manual Test

```bash
# Start log tail
aws logs tail /aws/lambda/llmproxy --since 1m --follow

# In UI, try:
# "get the transcript with timestamps for this video: https://www.youtube.com/watch?v=dQw4w9WgXcQ"

# Look for in logs:
# ‚úÖ Fetched transcript with 150 segments (8234 chars)
```

### Expected Log Output

```
üìù Fetching detailed transcript for dQw4w9WgXcQ (timestamps: true, language: en)
Fetching YouTube transcript for: https://www.youtube.com/watch?v=dQw4w9WgXcQ
Extracted video ID: dQw4w9WgXcQ
Found 2 caption tracks: [{language: 'en', name: 'English', kind: 'ASR'}]
Using caption track: en (ASR) - English
‚úÖ Fetched transcript with 150 segments (8234 chars)
```

## Future Enhancements

### Possible additions:
1. **Search within transcript**: Find text in specific time range
2. **Multiple languages**: Return all available caption tracks
3. **Export formats**: SRT, VTT, JSON download
4. **Segment filtering**: Get only segments matching criteria
5. **Translation**: Translate segments to different language
6. **Summarization**: AI summary of each segment/section

### Performance optimizations:
1. **Cache transcripts**: Store in DynamoDB for repeated requests
2. **Streaming response**: Stream segments as they're parsed
3. **Batch processing**: Handle multiple videos at once

## Related Files

- `src/youtube-api.js` - Core transcript fetching logic
- `src/tools.js` - Tool definition and handler
- `YOUTUBE_OAUTH_SCOPE_FIX.md` - OAuth scope requirements
- `YOUTUBE_TRANSCRIPT_MODULE_FIX.md` - Module deployment fix

## Status: DEPLOYED ‚úÖ

New `get_youtube_transcript` tool available in production. Users can now request timestamps, language info, and detailed metadata from YouTube videos.

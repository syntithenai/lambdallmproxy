<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Search</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .form-container {
            background-color: #fff;
            padding: 12px 20px;
            border-bottom: 2px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 1.2rem;
            display: inline-block;
            margin-right: 20px;
        }

        .form-row {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row-top {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .form-row-bottom {
            width: 100%;
        }

        .form-row-bottom .form-group {
            width: 100%;
        }

        .form-row-bottom label {
            display: block;
            margin-bottom: 6px;
        }

        label {
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
            margin: 0;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group.query-group {
            flex: 1;
            min-width: 300px;
        }

        input[type="text"],
        textarea,
        select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        #model {
            width: 180px;
        }

        #prompt {
            flex: 1;
            resize: vertical;
            height: auto;
            min-height: 200px;
            width: 100%;
        }

        .search-mode-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-mode-option {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .search-mode-option input[type="radio"] {
            margin: 0;
        }

        button[type="submit"] {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        button[type="submit"]:hover:not(:disabled) {
            background: #0056b3;
        }

        button[type="submit"]:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .response-container {
            flex: 1;
            margin: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: none;
        }

        .response-container.loading {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }

        .response-container.response-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .response-container.response-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .response-container pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            margin: 0;
        }

        /* Enhanced response styles */
        .answer-content {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .search-summaries {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .search-summaries h3 {
            margin: 0 0 15px 0;
            color: #0056b3;
            font-size: 1.1em;
        }

        .search-summary {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-summary:last-child {
            border-bottom: none;
        }

        .response-links {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .response-links h3 {
            margin: 0 0 15px 0;
            color: #1e7e34;
            font-size: 1.1em;
        }

        .link-item {
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .link-item:last-child {
            border-bottom: none;
        }

        .link-item a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .link-item a:hover {
            text-decoration: underline;
        }

        .link-item small {
            color: #6c757d;
            font-size: 0.9em;
        }

        .debug-info {
            margin: 20px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .debug-info summary {
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .debug-info pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8em;
            max-height: 300px;
            overflow-y: auto;
        }

        .advanced-toggle {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .advanced-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
        }

        .advanced-toggle input[type="checkbox"] {
            margin-right: 8px;
        }

        .advanced-panel {
            margin: 15px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .advanced-panel h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .advanced-panel h3:not(:first-child) {
            margin-top: 25px;
        }

        .advanced-panel .form-group {
            margin-bottom: 20px;
        }

        .advanced-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .advanced-panel textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            min-height: 60px;
            box-sizing: border-box;
        }

        .advanced-panel textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        /* Settings Dialog Styles */
        .settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .settings-button:hover {
            background: #0056b3;
        }

        /* Login Button Styles */
        .login-button {
            position: fixed;
            top: 20px;
            right: 80px;
            height: 40px;
            border-radius: 20px;
            background: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: background-color 0.3s;
        }

        .login-button:hover {
            background: #3367d6;
        }

        .login-button.logged-in {
            background: #34a853;
            padding: 0;
            width: 120px;
        }

        .profile-container {
            display: flex;
            align-items: center;
            padding: 0 12px;
            width: 100%;
        }

        .profile-picture {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .logout-text {
            font-size: 12px;
        }

        .settings-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
        }

        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .settings-header h2 {
            margin: 0;
            color: #333;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: #333;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            margin: 0 0 1rem 0;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        /* Settings form styles */
        .settings-dialog .form-group {
            display: block;
            margin-bottom: 1.5rem;
        }

        .settings-dialog .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .settings-dialog textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            min-height: 60px;
            box-sizing: border-box;
        }

        .settings-dialog textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .settings-separator {
            height: 1px;
            background: linear-gradient(to right, transparent, #dee2e6, transparent);
            margin: 2rem 0;
            position: relative;
        }

        .settings-separator::before {
            content: "Templates";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 1rem;
            color: #6c757d;
            font-size: 0.9em;
            font-weight: 500;
        }
    </style>
</head>
<body>

<!-- Login Button -->
<button class="login-button" id="login-btn">
    <span id="login-text">Sign in with Google</span>
</button>

<!-- Settings Button -->
<button class="settings-button" id="settings-btn" title="Settings">⚙️</button>

<!-- Settings Dialog -->
<div class="settings-dialog" id="settings-dialog">
    <div class="settings-content">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-button" id="close-settings">×</button>
        </div>
        
        <div class="settings-section">
            <h3>API Keys</h3>
            <div>
                <label for="openai_api_key">OpenAI API Key:</label>
                <div style="position: relative;">
                    <input type="text" id="openai_api_key" name="openai_api_key" placeholder="sk-...">
                    <small id="openai_api_key_status" style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;"></small>
                    <button type="button" id="clear_openai_api_key" style="position: absolute; right: 8px; top: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 4px 8px; font-size: 0.8em; color: #6c757d; cursor: pointer; display: none;" title="Clear saved API key">Clear</button>
                </div>
            </div>
            <div>
                <label for="groq_api_key">Groq API Key:</label>
                <div style="position: relative;">
                    <input type="text" id="groq_api_key" name="groq_api_key" placeholder="gsk_...">
                    <small id="groq_api_key_status" style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;"></small>
                    <button type="button" id="clear_groq_api_key" style="position: absolute; right: 8px; top: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 4px 8px; font-size: 0.8em; color: #6c757d; cursor: pointer; display: none;" title="Clear saved API key">Clear</button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3>Advanced Prompt Settings</h3>
            
            <div class="form-group">
                <label for="system-prompt-decision">Decision System Prompt:</label>
                <textarea id="system-prompt-decision" name="system_prompt_decision" rows="3" placeholder="System prompt for deciding whether to search or respond directly">You are a helpful assistant that determines whether a question can be answered directly or requires web search for fact-checking. Always respond with valid JSON only.</textarea>
            </div>

            <div class="form-group">
                <label for="system-prompt-direct">Direct Response System Prompt:</label>
                <textarea id="system-prompt-direct" name="system_prompt_direct" rows="3" placeholder="System prompt for direct responses">You are a helpful assistant. Answer the user's question directly based on your knowledge. Be comprehensive and informative.</textarea>
            </div>

            <div class="form-group">
                <label for="system-prompt-search">Search Response System Prompt:</label>
                <textarea id="system-prompt-search" name="system_prompt_search" rows="3" placeholder="System prompt for search-based responses">You are a helpful research assistant. Use the provided search results to answer questions comprehensively. Always cite specific sources using the URLs provided when making factual claims. Format your response in a clear, organized manner.</textarea>
            </div>

            <div class="form-group">
                <label for="system-prompt-multisearch">Multi-Search System Prompt:</label>
                <textarea id="system-prompt-multisearch" name="system_prompt_multisearch" rows="3" placeholder="System prompt for multi-search final responses">You are a comprehensive research assistant. Synthesize information from multiple searches to provide thorough, well-cited answers. Organize information logically and include relevant source URLs for factual claims.</textarea>
            </div>

            <!-- Separator between system prompts and templates -->
            <div class="settings-separator"></div>

            <div class="form-group">
                <label for="decision-template">Decision Template:</label>
                <textarea id="decision-template" name="decision_template" rows="8" placeholder="Template for decision prompts (use {{QUERY}} as placeholder)">Analyze this question and determine if you can answer it directly or if it requires web searches.

IMPORTANT: Respond ONLY with valid JSON in one of these formats:

For questions you can answer directly (general knowledge, explanations, creative tasks, personal advice):
{"response": "Your complete answer here"}

For questions requiring web searches (current events, recent data, specific facts, company information):
{"search_queries": ["search terms 1", "search terms 2", "search terms 3"]}

Guidelines:
- Use "response" for: general knowledge, explanations, creative writing, personal advice, theoretical concepts, historical facts (pre-2023)
- Use "search_queries" for: current events, recent developments, specific statistics, factual claims that need verification, breaking news, real-time information
- If using search_queries, provide 1-3 distinct search queries that cover different aspects of the question
- Each search query should be optimized for web search (remove question words, focus on key terms)

Question: {{QUERY}}</textarea>
            </div>

            <div class="form-group">
                <label for="search-template">Search Template (Legacy - for single search mode):</label>
                <textarea id="search-template" name="search_template" rows="6" placeholder="Template for single search-based prompts">Based on the search results below, please provide a comprehensive answer to the user's question.

Search Results:
{{SEARCH_CONTEXT}}

User Question: {{QUERY}}

Please provide a detailed, well-structured response using the search results. Include relevant URLs when citing sources.</textarea>
            </div>
        </div>
    </div>
</div>

<div class="form-container">
    <form id="llm-form">
        <input type="hidden" id="access_secret" name="access_secret" value="FUCKoffNOW2">
        
        <div class="form-row-top">
            <h1>AI Search</h1>
            
            <div class="form-group">
                <label for="model">Model:</label>
                <select id="model" name="model">
                    <optgroup label="Groq Models" id="groq-models">
                        <option value="groq:llama-3.1-8b-instant">Llama 3.1 8B Instant</option>
                        <option value="groq:llama-3.1-70b-versatile">Llama 3.1 70B Versatile</option>
                        <option value="groq:llama-3.1-405b-reasoning">Llama 3.1 405B Reasoning</option>
                        <option value="groq:mixtral-8x7b-32768">Mixtral 8x7B</option>
                    </optgroup>
                    <optgroup label="OpenAI Models" id="openai-models">
                        <option value="openai:gpt-5">GPT-5</option>
                        <option value="openai:gpt-5-mini">GPT-5 Mini</option>
                        <option value="openai:gpt-5-nano">GPT-5 Nano</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>Search:</label>
                <div class="search-mode-group">
                    <div class="search-mode-option">
                        <input type="radio" id="search_auto" name="search_mode" value="auto" checked>
                        <label for="search_auto">Auto</label>
                    </div>
                    <div class="search-mode-option">
                        <input type="radio" id="search_force" name="search_mode" value="search">
                        <label for="search_force">Search</label>
                    </div>
                    <div class="search-mode-option">
                        <input type="radio" id="search_skip" name="search_mode" value="direct">
                        <label for="search_skip">Direct</label>
                    </div>
                </div>
            </div>
            
            <button type="submit" id="submit-btn" disabled>Sign in to Send Request</button>
        </div>

        <div class="form-row-bottom">
            <div class="form-group">
                <label for="prompt">Query:</label>
                <textarea id="prompt" name="prompt" rows="10" required placeholder="Enter your question here...">how old is the first child of the king of spain</textarea>
            </div>
        </div>
    </form>
</div>

<div id="response-container" class="response-container">
    <!-- Response will be displayed here -->
</div>

<script>
// Global Google OAuth variables
let googleUser = null;
let googleAccessToken = null;

// Handle API key persistence and model selection
document.addEventListener('DOMContentLoaded', function() {
    // Google OAuth configuration
    const GOOGLE_CLIENT_ID = '927667106833-7od90q7nh5oage0shc3kka5s9vtg2loj.apps.googleusercontent.com'; // Replaced during build process

    // API key elements
    const openaiApiKeyInput = document.getElementById('openai_api_key');
    const groqApiKeyInput = document.getElementById('groq_api_key');
    const clearOpenaiButton = document.getElementById('clear_openai_api_key');
    const clearGroqButton = document.getElementById('clear_groq_api_key');
    const modelSelect = document.getElementById('model');
    
    // Login elements
    const loginBtn = document.getElementById('login-btn');
    const loginText = document.getElementById('login-text');
    const submitBtn = document.getElementById('submit-btn');
    
    // Settings dialog elements
    const settingsBtn = document.getElementById('settings-btn');
    const settingsDialog = document.getElementById('settings-dialog');
    const closeSettingsBtn = document.getElementById('close-settings');
    
    // Model groups
    const openaiModels = document.getElementById('openai-models');
    const groqModels = document.getElementById('groq-models');
    
    // Function to update API key status
    function updateApiKeyStatus(elementId, message, color = '#6c757d') {
        const statusElement = document.getElementById(elementId);
        statusElement.textContent = message;
        statusElement.style.color = color;
    }
    
    // Google OAuth functions
    function initializeGoogleOAuth() {
        if (typeof google !== 'undefined' && google.accounts) {
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleSignIn
            });
            
            // Try to restore previous session
            const savedToken = localStorage.getItem('google_access_token');
            const savedUser = localStorage.getItem('google_user');
            if (savedToken && savedUser) {
                googleAccessToken = savedToken;
                googleUser = JSON.parse(savedUser);
                updateLoginUI(true);
                updateSubmitButton(true);
                console.log('Restored Google session');
            }
        } else {
            console.error('Google Identity Services not loaded');
        }
    }
    
    function handleGoogleSignIn(response) {
        try {
            // Decode the JWT token to get user info
            const userInfo = parseJwt(response.credential);
            googleUser = {
                email: userInfo.email,
                name: userInfo.name,
                picture: userInfo.picture
            };
            googleAccessToken = response.credential;
            
            // Save to localStorage
            localStorage.setItem('google_access_token', googleAccessToken);
            localStorage.setItem('google_user', JSON.stringify(googleUser));
            
            updateLoginUI(true);
            updateSubmitButton(true);
            console.log('Google sign-in successful:', googleUser.email);
        } catch (error) {
            console.error('Error handling Google sign-in:', error);
        }
    }
    
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
    
    function updateLoginUI(isLoggedIn) {
        if (isLoggedIn && googleUser) {
            loginBtn.classList.add('logged-in');
            loginBtn.innerHTML = `
                <div class="profile-container">
                    <img src="${googleUser.picture}" alt="Profile" class="profile-picture">
                    <span class="logout-text">Logout</span>
                </div>
            `;
        } else {
            loginBtn.classList.remove('logged-in');
            loginBtn.innerHTML = '<span id="login-text">Sign in with Google</span>';
        }
    }
    
    function updateSubmitButton(isLoggedIn) {
        if (isLoggedIn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Request';
        } else {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sign in to Send Request';
        }
    }
    
    function handleLogin() {
        if (googleUser) {
            // User is logged in, so logout
            logout();
        } else {
            // User is not logged in, so show sign-in prompt
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.prompt();
            } else {
                console.error('Google Identity Services not available');
            }
        }
    }
    
    function logout() {
        googleUser = null;
        googleAccessToken = null;
        localStorage.removeItem('google_access_token');
        localStorage.removeItem('google_user');
        updateLoginUI(false);
        updateSubmitButton(false);
        console.log('Logged out');
    }
    
    // Function to update model availability based on API keys
    function updateModelAvailability() {
        console.log('updateModelAvailability called');
        const hasOpenaiKey = openaiApiKeyInput.value.trim() && openaiApiKeyInput.value !== '';
        const hasGroqKey = groqApiKeyInput.value.trim() && groqApiKeyInput.value !== '';
        
        console.log('hasOpenaiKey:', hasOpenaiKey, 'hasGroqKey:', hasGroqKey);
        
        // Enable/disable individual options based on available API keys, but keep them visible
        const allOptions = modelSelect.querySelectorAll('option');
        let hasAvailableOptions = false;
        let firstAvailableOption = null;
        
        allOptions.forEach(option => {
            if (!option.value) {
                // Skip empty options
                return;
            }
            
            let shouldEnable = false;
            if (option.value.startsWith('openai:')) {
                shouldEnable = hasOpenaiKey;
                // Add visual indicator for disabled options
                option.textContent = option.textContent.replace(' (requires API key)', '');
                if (!shouldEnable) {
                    option.textContent += ' (requires API key)';
                }
            } else if (option.value.startsWith('groq:')) {
                shouldEnable = hasGroqKey;
                // Add visual indicator for disabled options
                option.textContent = option.textContent.replace(' (requires API key)', '');
                if (!shouldEnable) {
                    option.textContent += ' (requires API key)';
                }
            }
            
            option.disabled = !shouldEnable;
            // Keep all options visible, just disable unavailable ones
            option.style.display = '';
            
            if (shouldEnable) {
                hasAvailableOptions = true;
                if (!firstAvailableOption) {
                    firstAvailableOption = option;
                }
            }
        });
        
        // If no keys available, disable the entire selector
        if (!hasAvailableOptions) {
            modelSelect.disabled = true;
            console.log('No API keys available, disabling model select');
        } else {
            modelSelect.disabled = false;
            console.log('API keys available, enabling model select');
            
            // Check if current selection is still valid
            const currentOption = modelSelect.querySelector(`option[value="${modelSelect.value}"]`);
            if (!currentOption || currentOption.disabled) {
                // Set default model based on available API keys
                let defaultModel = null;
                
                // Priority 1: Groq llama instant if Groq key is available (and no OpenAI key)
                if (hasGroqKey) {
                    defaultModel = 'groq:llama-3.1-8b-instant';
                // Priority 2: OpenAI gpt-5-nano if OpenAI key is available
                } else if (hasOpenaiKey) {
                    defaultModel = 'openai:gpt-5-nano';
                }
                 
                
                // Apply default model if available, otherwise use first available option
                if (defaultModel && modelSelect.querySelector(`option[value="${defaultModel}"]`) && 
                    !modelSelect.querySelector(`option[value="${defaultModel}"]`).disabled) {
                    modelSelect.value = defaultModel;
                    console.log('Selected default model:', defaultModel);
                } else if (firstAvailableOption) {
                    modelSelect.value = firstAvailableOption.value;
                    console.log('Selected first available model:', firstAvailableOption.value);
                }
            }
        }
    }
    
    // Load saved API keys on page load
    const savedOpenaiApiKey = localStorage.getItem('openai_api_key');
    if (savedOpenaiApiKey) {
        openaiApiKeyInput.value = savedOpenaiApiKey;
        updateApiKeyStatus('openai_api_key_status', 'Loaded from local storage', '#28a745');
        clearOpenaiButton.style.display = 'block';
    }
    
    const savedGroqApiKey = localStorage.getItem('groq_api_key');
    if (savedGroqApiKey) {
        groqApiKeyInput.value = savedGroqApiKey;
        updateApiKeyStatus('groq_api_key_status', 'Loaded from local storage', '#28a745');
        clearGroqButton.style.display = 'block';
    }
    
    // Set initial default model based on available API keys
    function setInitialDefaultModel() {
        const hasOpenaiKey = savedOpenaiApiKey && savedOpenaiApiKey.trim();
        const hasGroqKey = savedGroqApiKey && savedGroqApiKey.trim();
        
        // Only set default if no model is currently selected
        if (!modelSelect.value || modelSelect.value === '') {
            if (hasOpenaiKey) {
                modelSelect.value = 'openai:gpt-5-nano';
                console.log('Set initial default model to gpt-5-nano (OpenAI key available)');
            } else if (hasGroqKey) {
                modelSelect.value = 'groq:llama-3.1-8b-instant';
                console.log('Set initial default model to llama-3.1-8b-instant (Groq key available)');
            }
        }
    }
    
    // Update model availability on initial load
    updateModelAvailability();
    
    // Set initial default model
    setInitialDefaultModel();
    
    // Also call it after a small delay to ensure localStorage values are set
    setTimeout(updateModelAvailability, 100);
    
    // Save OpenAI API key when it changes
    openaiApiKeyInput.addEventListener('input', function() {
        const apiKey = this.value.trim();
        if (apiKey && apiKey.trim()) {
            localStorage.setItem('openai_api_key', apiKey);
            updateApiKeyStatus('openai_api_key_status', 'Saved to local storage', '#28a745');
            clearOpenaiButton.style.display = 'block';
        } else if (!apiKey) {
            updateApiKeyStatus('openai_api_key_status', '');
            clearOpenaiButton.style.display = 'none';
        }
        updateModelAvailability();
    });
    
    // Save Groq API key when it changes
    groqApiKeyInput.addEventListener('input', function() {
        const apiKey = this.value.trim();
        if (apiKey && apiKey.trim()) {
            localStorage.setItem('groq_api_key', apiKey);
            updateApiKeyStatus('groq_api_key_status', 'Saved to local storage', '#28a745');
            clearGroqButton.style.display = 'block';
        } else if (!apiKey) {
            updateApiKeyStatus('groq_api_key_status', '');
            clearGroqButton.style.display = 'none';
        }
        updateModelAvailability();
    });
    
    // Handle clear OpenAI button
    clearOpenaiButton.addEventListener('click', function() {
        localStorage.removeItem('openai_api_key');
        openaiApiKeyInput.value = '';
        updateApiKeyStatus('openai_api_key_status', 'Cleared from local storage', '#dc3545');
        clearOpenaiButton.style.display = 'none';
        updateModelAvailability();
        setTimeout(() => {
            updateApiKeyStatus('openai_api_key_status', '');
        }, 3000);
    });
    
    // Handle clear Groq button
    clearGroqButton.addEventListener('click', function() {
        localStorage.removeItem('groq_api_key');
        groqApiKeyInput.value = '';
        updateApiKeyStatus('groq_api_key_status', 'Cleared from local storage', '#dc3545');
        clearGroqButton.style.display = 'none';
        updateModelAvailability();
        setTimeout(() => {
            updateApiKeyStatus('groq_api_key_status', '');
        }, 3000);
    });
    
    // Settings dialog functionality
    function openSettings() {
        settingsDialog.style.display = 'block';
    }
    
    function closeSettings() {
        settingsDialog.style.display = 'none';
    }
    
    // Check if API keys are available, open settings if not
    function checkInitialSettings() {
        const hasOpenaiKey = localStorage.getItem('openai_api_key');
        const hasGroqKey = localStorage.getItem('groq_api_key');
        
        // Open settings dialog by default if no API keys are set
        if (!hasOpenaiKey && !hasGroqKey) {
            openSettings();
        }
    }
    
    // Settings button event listeners
    settingsBtn.addEventListener('click', openSettings);
    closeSettingsBtn.addEventListener('click', closeSettings);
    
    // Login button event listener
    loginBtn.addEventListener('click', handleLogin);
    
    // Initialize Google OAuth when the page loads
    setTimeout(initializeGoogleOAuth, 1000); // Delay to ensure Google script is loaded
    
    // Close dialog when clicking outside
    settingsDialog.addEventListener('click', function(e) {
        if (e.target === settingsDialog) {
            closeSettings();
        }
    });
    
    // Close dialog with escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && settingsDialog.style.display === 'block') {
            closeSettings();
        }
    });
    
    // Check initial settings after everything is loaded
    checkInitialSettings();
});

document.getElementById('llm-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const responseContainer = document.getElementById('response-container');
    
    // Disable submit button and show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    
    // Show loading message
    responseContainer.className = 'response-container loading';
    responseContainer.style.display = 'block';
    responseContainer.textContent = 'Sending request to Lambda function...';
    
    // Get the selected model to determine which API key to use
    const selectedModel = document.getElementById('model').value;
    const isGroqModel = selectedModel.startsWith('groq:');
    const isOpenaiModel = selectedModel.startsWith('openai:');
    
    // Get the appropriate API key
    let apiKey;
    if (isGroqModel) {
        apiKey = document.getElementById('groq_api_key').value;
    } else if (isOpenaiModel) {
        apiKey = document.getElementById('openai_api_key').value;
    }
    
    // Validate API key
    if (!apiKey || !apiKey.trim()) {
        responseContainer.className = 'response-container response-error';
        responseContainer.textContent = `Error: No API key provided for ${isGroqModel ? 'Groq' : 'OpenAI'} models.`;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Request';
        return;
    }
    
    // Validate login
    if (!googleAccessToken) {
        responseContainer.className = 'response-container response-error';
        responseContainer.textContent = 'Error: Please sign in with Google to send requests.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Request';
        return;
    }

    // Collect form data
    const searchMode = document.querySelector('input[name="search_mode"]:checked').value;
    const formData = {
        api_key: apiKey,
        model: selectedModel,
        query: document.getElementById('prompt').value,
        access_secret: document.getElementById('access_secret').value,
        search_mode: searchMode,
        google_token: googleAccessToken // Add Google access token
    };

    // Include advanced settings if they have values
    const advancedFields = [
        'system_prompt_decision',
        'system_prompt_direct', 
        'system_prompt_search',
        'decision_template',
        'search_template'
    ];

    advancedFields.forEach(field => {
        const element = document.getElementById(field.replace('_', '-'));
        if (element && element.value && element.value.trim()) {
            formData[field] = element.value;
        }
    });

    // Set a reasonable default timeout (60 seconds)
    const timeoutMs = 60000;

    // Create an AbortController for timeout handling
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, timeoutMs);
    
    try {
        console.log('Sending request to:', 'https://nrw7pperjjdswbmqgmigbwsbyi0rwdqf.lambda-url.us-east-1.on.aws/');
        console.log('Request data:', formData);
        
        // Update loading message
        responseContainer.textContent = 'Sending request to Lambda function...';
        
        const response = await fetch('https://nrw7pperjjdswbmqgmigbwsbyi0rwdqf.lambda-url.us-east-1.on.aws/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
            mode: 'cors',
            credentials: 'omit',
            signal: controller.signal // Add timeout signal
        });
        
        // Clear the timeout since we got a response
        clearTimeout(timeoutId);
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const responseData = await response.text();
        console.log('Response data:', responseData);
        
        if (response.ok) {
            // Success response - parse JSON and display enhanced response
            try {
                const jsonData = JSON.parse(responseData);
                const answer = jsonData.answer || 'No answer found in response';
                
                responseContainer.className = 'response-container response-success';
                responseContainer.style.fontFamily = 'inherit';
                
                // Create enhanced response with answer, summaries, and links
                let responseHTML = `<div class="answer-content">${answer.replace(/\n/g, '<br>')}</div>`;
                
                // Add search summaries if available
                if (jsonData.searchSummaries && jsonData.searchSummaries.length > 0) {
                    responseHTML += '<div class="search-summaries"><h3>Search Summaries</h3>';
                    jsonData.searchSummaries.forEach((summary, index) => {
                        responseHTML += `<div class="search-summary">
                            <strong>Search ${index + 1}:</strong> ${summary.searchQuery}<br>
                            <em>${summary.summary}</em>
                        </div>`;
                    });
                    responseHTML += '</div>';
                }
                
                // Add links if available
                if (jsonData.links && jsonData.links.length > 0) {
                    responseHTML += '<div class="response-links"><h3>Sources</h3>';
                    jsonData.links.forEach((link, index) => {
                        responseHTML += `<div class="link-item">
                            <a href="${link.url}" target="_blank">${link.title}</a><br>
                            <small>${link.snippet}</small>
                        </div>`;
                    });
                    responseHTML += '</div>';
                }
                
                // Add debug info for search results if available
                if (jsonData.searchResults && jsonData.searchResults.length > 0) {
                    responseHTML += `<details class="debug-info">
                        <summary>Full Search Results JSON (${jsonData.searchResults.length} results)</summary>
                        <pre>${JSON.stringify(jsonData.searchResults, null, 2)}</pre>
                    </details>`;
                }
                
                responseContainer.innerHTML = responseHTML;
            } catch (parseError) {
                // If JSON parsing fails, show the raw response
                responseContainer.className = 'response-container response-success';
                responseContainer.textContent = `Success (${response.status}):\n\n${responseData}`;
            }
        } else {
            // Error response from server
            responseContainer.className = 'response-container response-error';
            responseContainer.style.fontFamily = 'monospace'; // Keep monospace for error details
            responseContainer.textContent = `Error (${response.status}):\n\n${responseData}`;
        }
    } catch (error) {
        // Clear the timeout in case of other errors
        clearTimeout(timeoutId);
        
        // Network or other errors
        console.error('Request error:', error);
        
        responseContainer.className = 'response-container response-error';
        
        if (error.name === 'AbortError') {
            // Request was aborted due to timeout
            responseContainer.textContent = `Request Timeout Error:\n\nThe request timed out after 60 seconds. The Lambda function may be taking longer than expected to process your request.\n\nYou can try:\n- Simplifying your query\n- Checking if the Lambda function is running properly\n- Trying again in a moment`;
        } else {
            // Other network or fetch errors
            responseContainer.textContent = `Network Error:\n\n${error.message}\n\nCheck browser console for more details.`;
        }
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Request';
    }
});
</script>

</body>
</html>

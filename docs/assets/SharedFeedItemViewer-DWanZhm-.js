import{u as B,b as O,a as W,m as z,d as V,r as i,j as e,M as J,f as C,h as q,n as K,o as Q}from"./index-BJ_WKHd_.js";const X=()=>{try{const c=window.location.pathname.match(/\/feed\/share\/(.+)/);if(c&&c[1]){const o=c[1],u=Q.decompressFromEncodedURIComponent(o);return u?JSON.parse(u):(console.error("Failed to decompress feed item data"),null)}return null}catch(l){return console.error("Error decoding feed item data:",l),null}},ae=()=>{const l=B(),[c]=O(),{isAuthenticated:o,getToken:u}=W(),{getCurrentProjectId:E}=z(),{addSnippet:y}=V(),[t,v]=i.useState(null),[P,m]=i.useState(!0),[w,d]=i.useState(null),[g,x]=i.useState(!1),[f,p]=i.useState(!1),[L,j]=i.useState(!1),[k,N]=i.useState(!1),[G,b]=i.useState(!1);i.useEffect(()=>{(async()=>{try{let r=c.get("docId");if(!r&&window.location.hash.includes("?")&&(r=new URLSearchParams(window.location.hash.split("?")[1]).get("docId")),console.log("ðŸ” SharedFeedItemViewer loading with params:",{docId:r,hash:window.location.hash,isAuthenticated:o}),r){if(!o){console.log("ðŸ”’ Authentication required to view Google Docs share"),j(!0),m(!1);return}j(!1),console.log("ðŸ“ Loading shared feed item from Google Docs:",r);try{let a;try{console.log("ðŸŒ Attempting public download via authenticated proxy"),a=await C(r,""),console.log("âœ… Successfully downloaded as public file")}catch{if(console.log("âš ï¸ Public download failed, trying with Drive API authentication"),!q.hasDriveAccess()){console.log("ðŸ“ Drive permissions required - showing permission UI..."),b(!0),m(!1);return}const A=await u();if(!A)throw new Error("Failed to get access token");a=await C(r,A)}const h=new DOMParser().parseFromString(a,"text/html"),_=h.querySelector("h1")?.textContent||"Shared Feed Item",D=Array.from(h.querySelectorAll("p")).find(n=>n.textContent?.startsWith("Topics:")),H=D?D.textContent.replace("Topics:","").split(",").map(n=>n.trim()):[],M=h.querySelector("img")?.getAttribute("src")||void 0,Y=h.querySelectorAll("div")[0]?.textContent||"",$=Array.from(h.querySelectorAll("h2")).find(n=>n.textContent?.includes("Full Content"))?.nextElementSibling?.textContent||void 0,I=Array.from(h.querySelectorAll("h2")).find(n=>n.textContent?.includes("Sources"))?.nextElementSibling,F=[];I&&I.querySelectorAll("a").forEach(n=>{F.push(n.getAttribute("href")||"")}),v({type:"feed_item",title:_,content:Y,topics:H,image:M,sources:F,expandedContent:$}),console.log("âœ… Loaded feed item from Google Docs")}catch(a){console.error("Failed to load Google Docs content:",a),a instanceof Error&&a.message.includes("404")?d("This shared feed item was not found. It may have been deleted or is not shared with you."):a instanceof Error&&a.message.includes("403")?d("You do not have permission to access this feed item. Please ask the owner to share it with you."):a instanceof Error&&a.message.includes("401")?d("Your Google Drive authentication has expired. Please log out and log back in."):d(`Failed to load shared feed item: ${a instanceof Error?a.message:"Unknown error"}`)}}else{const a=X();a?(v(a),console.log("ðŸ“° Loaded shared feed item:",a.title||"Untitled")):d("Invalid or missing feed item data in URL")}}catch(r){console.error("Failed to load shared feed item:",r),d("Failed to decode feed item data")}finally{m(!1)}})()},[c,o]),i.useEffect(()=>{(async()=>{if(!(!t||!o||k||g)){console.log("ðŸ’¾ Auto-saving shared feed item to collection..."),N(!0),x(!0);try{const r=await y(t.content,"user",t.title,t.topics||[]);console.log("âœ… Auto-saved feed item to collection"),p(!0),r&&setTimeout(()=>{l(`/snippet/${r.id}`)},1e3)}catch(r){console.error("Failed to auto-save feed item:",r),N(!1)}finally{x(!1)}}})()},[t,o,k,g,y,l]);const T=async()=>{try{m(!0),console.log("ðŸ“ Requesting Drive permissions (user-initiated)..."),await q.requestDriveAccess()?(console.log("âœ… Drive permissions granted, reloading page..."),window.location.reload()):(d("Drive permissions are required to view this shared feed item"),m(!1),b(!1))}catch(s){console.error("Failed to request Drive access:",s),d("Failed to request Drive permissions. Please try again."),m(!1),b(!1)}},R=async()=>{if(!(!t||!o)){x(!0);try{const s={id:`shared-${Date.now()}`,type:"did-you-know",title:t.title,content:t.content,expandedContent:t.expandedContent,mnemonic:t.mnemonic,image:t.image,topics:t.topics||[],sources:t.sources?.map(r=>typeof r=="string"?r:r.url)||[],createdAt:new Date().toISOString(),viewed:!1,stashed:!0,trashed:!1,projectId:E()||void 0};await K.saveItems([s]),p(!0),setTimeout(()=>p(!1),3e3)}catch(s){console.error("Failed to save feed item:",s)}finally{x(!1)}}},U=()=>{l(o?"/?tab=feed":"/login?redirect=/?tab=feed")};return P?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading shared feed item..."})]})}):L?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-blue-500 text-5xl mb-4",children:"ðŸ”’"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Login Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared feed item is stored in Google Drive and requires you to sign in to view it."}),e.jsx("button",{onClick:()=>{sessionStorage.setItem("auth_redirect",window.location.hash),sessionStorage.setItem("request_drive_access","true"),l("/login")},className:"w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mb-3",children:"Sign In with Google Drive"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll be asked to grant Google Drive access to view this shared content"})]})}):G?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-green-500 text-5xl mb-4",children:"ðŸ“"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Drive Access Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared feed item is stored in Google Drive. Please grant access to your Google Drive to view it."}),e.jsx("button",{onClick:T,className:"w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-3",children:"Grant Drive Access"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll see a Google permission popup. This only needs to be done once."})]})}):w||!t?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-red-500 text-5xl mb-4",children:"âš ï¸"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Unable to Load Feed Item"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:w||"The shared feed item could not be found or loaded."}),e.jsx("button",{onClick:U,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:o?"Go to Feed":"Go to Login"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Shared Feed Item"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Read-only preview"})]}),e.jsx("div",{children:o?e.jsx("button",{onClick:R,disabled:g||f,className:`px-4 py-2 rounded-md transition-colors text-sm font-medium flex items-center gap-2 ${f?"bg-green-600 text-white":g?"bg-gray-400 text-white cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:f?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),"Saved!"]}):g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Saving..."]}):"Save to Collection"}):e.jsx("button",{onClick:()=>l("/login?redirect="+encodeURIComponent(window.location.href)),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium",children:"Login"})})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:[t.image&&e.jsx("div",{className:"w-full h-64 bg-gray-100 dark:bg-gray-700 overflow-hidden",children:e.jsx("img",{src:t.image,alt:t.title,className:"w-full h-full object-cover",onError:s=>{s.currentTarget.style.display="none"}})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4",children:t.title}),t.topics&&t.topics.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:t.topics.map((s,r)=>e.jsx("span",{className:"px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-sm rounded-full",children:s},r))}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"Summary"}),e.jsx("div",{className:"prose dark:prose-invert max-w-none",children:e.jsx(J,{content:t.content})})]}),t.mnemonic&&e.jsx("div",{className:"mb-6 bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-400 dark:border-purple-600 p-4 rounded",children:e.jsxs("p",{className:"text-sm font-medium text-purple-900 dark:text-purple-100",children:["ðŸ’¡ ",t.mnemonic]})}),t.expandedContent&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"ðŸ“– Deep Dive"}),e.jsx("div",{className:"prose dark:prose-invert max-w-none whitespace-pre-line text-gray-700 dark:text-gray-300 leading-relaxed",children:t.expandedContent})]}),t.sources&&t.sources.length>0&&e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-3",children:"ðŸ“š Sources"}),e.jsx("ul",{className:"space-y-2",children:t.sources.map((s,r)=>{const a=typeof s=="string"?s:s.url,S=typeof s=="string"?s:s.title||s.url;return e.jsx("li",{children:e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 dark:text-blue-400 hover:underline break-all text-sm",children:S})},r)})})]})]})]}),e.jsx("div",{className:"mt-8 text-center",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Want to explore more AI-curated content? Login using the button at the top-right to continue."})})]})]})};export{ae as SharedFeedItemViewer};

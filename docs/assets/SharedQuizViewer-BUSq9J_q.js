import{u as E,b as F,a as B,m as R,e as U,r as a,j as e,h,Q as M,f as I,q as V}from"./index-Ba9w6Zmy.js";import{g as Y}from"./quizShareUtils-BK_Bl_yY.js";function O(){const m=E(),[x]=F(),{isAuthenticated:d,getToken:Q}=B(),{getCurrentProjectId:f}=R(),{showSuccess:b}=U(),[u,v]=a.useState(null),[A,o]=a.useState(!0),[w,i]=a.useState(null),[n,p]=a.useState(null),[G,y]=a.useState(0),[j,z]=a.useState(!1),[W,_]=a.useState(!1),[C,k]=a.useState(!1),[q,N]=a.useState(!1),[L,g]=a.useState(!1);a.useEffect(()=>{(async()=>{try{let t=x.get("docId");if(!t&&window.location.hash.includes("?")&&(t=new URLSearchParams(window.location.hash.split("?")[1]).get("docId")),console.log("ðŸ” SharedQuizViewer loading with params:",{docId:t,hash:window.location.hash,isAuthenticated:d}),t){if(!d){console.log("ðŸ”’ Authentication required to view Google Docs share"),k(!0),o(!1);return}k(!1),console.log("ðŸ“ Loading shared quiz from Google Docs:",t);try{let s;try{console.log("ðŸŒ Attempting public download via authenticated proxy"),s=await I(t,""),console.log("âœ… Successfully downloaded as public file")}catch{if(console.log("âš ï¸ Public download failed, trying with Drive API authentication"),!h.hasDriveAccess()){console.log("ðŸ“ Drive permissions required - showing permission UI..."),g(!0),o(!1);return}const D=await Q();if(!D)throw new Error("Failed to get access token");s=await I(t,D)}const l=JSON.parse(s);if(l.type!=="quiz"||!l.questions){i("Invalid quiz data format"),o(!1);return}const S={version:1,timestamp:l.sharedAt?new Date(l.sharedAt).getTime():Date.now(),shareType:"quiz",quiz:{title:l.title,questions:l.questions.map(c=>({id:c.id,prompt:c.prompt,choices:c.choices,answerId:c.correctChoiceId||c.answerId,explanation:c.explanation}))},metadata:{compressed:!1,originalSize:s.length,sharedBy:l.createdBy}};v(S),p(S.quiz),y(Date.now()),console.log("âœ… Loaded quiz from Google Docs")}catch(s){console.error("Failed to load Google Docs content:",s),s instanceof Error&&s.message.includes("404")?i("This shared quiz was not found. It may have been deleted or is not shared with you."):s instanceof Error&&s.message.includes("403")?i("You do not have permission to access this quiz. Please ask the owner to share it with you."):s instanceof Error&&s.message.includes("401")?i("Your Google Drive authentication has expired. Please log out and log back in."):i(`Failed to load shared quiz: ${s instanceof Error?s.message:"Unknown error"}`)}}else{const s=Y();if(!s){i("Invalid or missing quiz data in URL"),o(!1);return}v(s),p(s.quiz),y(Date.now())}}catch(t){console.error("Failed to load shared quiz:",t),i("Failed to load quiz data")}finally{o(!1)}})()},[x,d]),a.useEffect(()=>{(async()=>{if(!(!n||!d||q||j)){console.log("ðŸ’¾ Auto-saving shared quiz to collection..."),N(!0),z(!0);try{const t=f();await V.saveGeneratedQuiz(n.title,[],n.questions.length,!1,n,t||void 0)?(console.log("âœ… Auto-saved quiz to collection"),b("Quiz saved to your collection!")):console.log("â„¹ï¸ Quiz already exists in collection, skipping save")}catch(t){console.error("Failed to auto-save quiz:",t),N(!1)}finally{z(!1)}}})()},[n,d,q,j,f,b]);const P=async()=>{try{o(!0),console.log("ðŸ“ Requesting Drive permissions (user-initiated)..."),await h.requestDriveAccess()?(console.log("âœ… Drive permissions granted, reloading page..."),window.location.reload()):(i("Drive permissions are required to view this shared quiz"),o(!1),g(!1))}catch(r){console.error("Failed to request Drive access:",r),i("Failed to request Drive permissions. Please try again."),o(!1),g(!1)}},T=(r,t)=>{const s=Math.floor((Date.now()-G)/1e3);console.log("Quiz completed (shared, not saved):",{score:r,totalQuestions:t,duration:s,quiz:n?.title})};return A?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"Loading quiz..."})]})}):C?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-blue-500 text-5xl mb-4",children:"ðŸ”’"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Login Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared quiz is stored in Google Drive and requires you to sign in to view it."}),e.jsx("button",{onClick:async()=>{try{sessionStorage.setItem("auth_redirect",window.location.hash.slice(1)||"/"),sessionStorage.setItem("request_drive_access","true"),await h.signInWithDriveAccess()}catch(r){console.error("âŒ Sign-in failed:",r)}},className:"w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mb-3",children:"Sign In with Google Drive"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll be asked to grant Google Drive access to view this shared content"})]})}):L?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-green-500 text-5xl mb-4",children:"ðŸ“"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Drive Access Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared quiz is stored in Google Drive. Please grant access to your Google Drive to view it."}),e.jsx("button",{onClick:P,className:"w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-3",children:"Grant Drive Access"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll see a Google permission popup. This only needs to be done once."})]})}):w?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsx("div",{className:"max-w-md w-full",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 text-red-600 dark:text-red-400 mb-4",children:[e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h2",{className:"text-xl font-semibold",children:"Unable to Load Quiz"})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:w}),e.jsx("button",{onClick:()=>m("/"),className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Go to Home"})]})})}):!u||!n?null:e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("div",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Shared Quiz"})}),e.jsx("div",{children:!d&&e.jsxs("button",{onClick:async()=>{try{sessionStorage.setItem("auth_redirect",window.location.hash.slice(1)||"/"),await h.signIn()}catch(r){console.error("âŒ Sign-in failed:",r)}},className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm font-medium flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),"Login with Google"]})})]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-6 h-6 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-1",children:"Shared Quiz"}),e.jsx("p",{className:"text-sm text-blue-700 dark:text-blue-300 mb-2",children:"This quiz was shared with you. Your results will only be stored locally on your device."}),u.metadata?.sharedBy&&e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["Shared by: ",u.metadata.sharedBy]}),u.metadata?.enrichment&&e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:"âœ¨ This quiz includes AI-enriched questions"})]})]})}),e.jsx(M,{quiz:n,onClose:()=>m("/quiz"),onComplete:T})]})]})}export{O as default};

import{u as V,b as Y,a as _,d as K,e as O,r as i,j as e,M as J,f as q,h as k,i as Q}from"./index-Ba9w6Zmy.js";async function X(h){const n=new DOMParser().parseFromString(h,"text/html"),f=n.querySelectorAll("img");console.log(`üñºÔ∏è Found ${f.length} images to convert to base64`);for(const p of Array.from(f)){const t=p.getAttribute("src");if(!t){console.log("‚è≠Ô∏è Skipping image with no src");continue}if(t.startsWith("data:")){console.log("‚è≠Ô∏è Image already base64:",t.substring(0,50)+"...");continue}try{console.log(`üì• Fetching image: ${t.substring(0,100)}...`);let c;if(t.includes("googleusercontent.com")||t.includes("drive.google.com")){console.log("üîê Google Drive image detected, may need authentication");const a=await fetch(t,{mode:"cors",credentials:"include"});if(!a.ok){console.error(`‚ùå Failed to fetch Google Drive image: ${a.status} ${a.statusText}`),console.log("‚ö†Ô∏è Keeping original URL, image may not display after save");continue}c=await a.blob()}else{const a=await fetch(t);if(!a.ok){console.error(`‚ùå Failed to fetch image: ${a.status} ${a.statusText}`);continue}c=await a.blob()}const v=await new Promise((a,y)=>{const r=new FileReader;r.onloadend=()=>a(r.result),r.onerror=y,r.readAsDataURL(c)});console.log(`‚úÖ Converted image to base64 (${(v.length/1024).toFixed(1)} KB)`),p.setAttribute("src",v)}catch(c){console.error(`‚ùå Failed to convert image ${t}:`,c),console.log("‚ö†Ô∏è Keeping original URL, image may not display after save")}}const x=n.body.innerHTML;return console.log(`üì¶ Converted HTML length: ${x.length}`),x}const re=()=>{const h=V(),[w]=Y(),{isAuthenticated:n,getToken:f}=_(),{addSnippet:x}=K(),{showSuccess:p}=O(),[t,c]=i.useState(null),[v,a]=i.useState(!0),[y,r]=i.useState(null),[G,I]=i.useState(!1),[N,S]=i.useState(!1),[Z,ee]=i.useState(!1),[L,D]=i.useState(!1),[M,T]=i.useState(!1),[E,j]=i.useState(!1),[C,P]=i.useState(null);i.useEffect(()=>{(async()=>{try{let o=w.get("docId");if(!o&&window.location.hash.includes("?")&&(o=new URLSearchParams(window.location.hash.split("?")[1]).get("docId")),console.log("üîç SharedSnippetViewer loading with params:",{docId:o,hash:window.location.hash,isAuthenticated:n}),o){if(P(o),!n){console.log("üîí Authentication required to view Google Docs share"),T(!0),a(!1);return}T(!1),console.log("üìÑ Loading shared snippet from Google Docs:",o);try{let s;try{console.log("üåê Attempting public download via authenticated proxy"),s=await q(o,""),console.log("‚úÖ Successfully downloaded as public file")}catch{if(console.log("‚ö†Ô∏è Public download failed, trying with Drive API authentication"),!k.hasDriveAccess()){console.log("üìÅ Drive permissions needed"),j(!0),a(!1);return}const m=await f();if(console.log("üîë Got access token:",m?`${m.substring(0,20)}...`:"null"),!m)throw new Error("Failed to get access token");s=await q(o,m)}const u=new DOMParser().parseFromString(s,"text/html"),F=u.querySelector("h1")?.textContent||"Shared Snippet",U=u.querySelectorAll(".tag"),z=Array.from(U).map(g=>g.textContent||"").filter(g=>g.length>0),A=u.querySelector(".content");let l=A?.innerHTML||"";if(!l||l.trim().length===0){console.log("‚ö†Ô∏è .content element empty or missing, using full body HTML");const g=u.body.cloneNode(!0),m=g.querySelector("h1");m&&m.remove(),g.querySelectorAll(".tag").forEach(W=>W.remove()),l=g.innerHTML}console.log("üìù Raw content HTML length:",l.length);const b=l.match(/<img[^>]*>/gi);console.log("üñºÔ∏è Found img tags in extracted content:",b?b.length:0),b&&b.length>0&&console.log("üñºÔ∏è First img tag:",b[0].substring(0,200)),console.log("üìÑ Full HTML structure:",{hasContentDiv:!!A,bodyChildrenCount:u.body.children.length,bodyHTML:u.body.innerHTML.substring(0,500)}),console.log("üñºÔ∏è Converting images to base64...");const B=l;l=await X(l),console.log("‚úÖ Images converted to base64"),console.log("üìù Final content HTML length:",l.length),console.log(B===l?"‚ÑπÔ∏è No changes made during image conversion (images may already be base64)":"‚ú® Content modified during image conversion"),c({version:1,timestamp:Date.now(),shareType:"snippet",id:o,content:l,title:F,tags:z,metadata:{compressed:!1,originalSize:s.length}}),console.log("‚úÖ Loaded snippet from Google Docs:",F)}catch(s){console.error("Failed to load Google Docs content:",s),s instanceof Error&&s.message.includes("404")?r("This shared document was not found. It may have been deleted or is not shared with you. Please ask the owner to re-share it."):s instanceof Error&&s.message.includes("403")?r("You do not have permission to access this document. Please ask the owner to share it with you."):s instanceof Error&&s.message.includes("401")?r("Your Google Drive authentication has expired. Please log out and log back in."):r(`Failed to load shared document: ${s instanceof Error?s.message:"Unknown error"}`)}}else{const s=Q();s?(c(s),console.log("üìÑ Loaded shared snippet from URL:",s.title||"Untitled")):r("Invalid or missing snippet data in URL")}}catch(o){console.error("Failed to load shared snippet:",o),r("Failed to decode snippet data"),I(!0)}finally{a(!1)}})()},[w,n]),i.useEffect(()=>{(async()=>{if(!(!t||!n||L||N)){console.log("üíæ Auto-saving shared snippet to collection..."),D(!0),S(!0);try{console.log("üìù Content being saved, length:",t.content.length);const o=t.content.match(/<img[^>]*>/gi);console.log("üñºÔ∏è Images in content being saved:",o?o.length:0),o&&o.length>0&&console.log("üñºÔ∏è First img in save:",o[0].substring(0,150)+"...");const s=await x(t.content,t.sourceType||"user",t.title,t.tags||[],C||void 0);console.log("‚úÖ Auto-saved snippet to collection"),p("Content saved to your collection!"),s&&setTimeout(()=>{h(`/snippet/${s.id}`)},1e3)}catch(o){console.error("Failed to auto-save snippet:",o),D(!1)}finally{S(!1)}}})()},[t,n,L,N,x,h,C,p]);const R=async()=>{try{a(!0),console.log("üìÅ Requesting Drive permissions (user-initiated)..."),await k.requestDriveAccess()?(console.log("‚úÖ Drive permissions granted, reloading page..."),window.location.reload()):(r("Drive permissions are required to view this shared document"),a(!1),j(!1))}catch(d){console.error("Failed to request Drive access:",d),r("Failed to request Drive permissions. Please try again."),a(!1),j(!1)}},$=()=>{h(n?"/":"/login?redirect=/")},H=async()=>{try{sessionStorage.setItem("auth_redirect",window.location.hash.slice(1)||"/"),await k.signIn()}catch(d){console.error("‚ùå Sign-in failed:",d)}};return v?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading shared snippet..."})]})}):M?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-blue-500 text-5xl mb-4",children:"üîí"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Login Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared snippet is stored in Google Drive and requires you to sign in to view it."}),e.jsx("button",{onClick:()=>{sessionStorage.setItem("auth_redirect",window.location.hash),sessionStorage.setItem("request_drive_access","true"),h("/login")},className:"w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mb-3",children:"Sign In with Google Drive"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll be asked to grant Google Drive access to view this shared content"})]})}):E?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-green-500 text-5xl mb-4",children:"üìÅ"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Drive Access Required"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"This shared snippet is stored in Google Drive. Please grant access to your Google Drive to view it."}),e.jsx("button",{onClick:R,className:"w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-3",children:"Grant Drive Access"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"You'll see a Google permission popup. This only needs to be done once."})]})}):y&&G?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center",children:[e.jsx("div",{className:"text-red-500 text-5xl mb-4",children:"‚ö†Ô∏è"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Unable to Load Snippet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:y}),e.jsx("button",{onClick:$,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:n?"Go to Chat":"Go to Login"})]})}):t?e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"fixed top-0 right-0 left-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm z-10",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl",children:"üìÑ"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Shared Snippet"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"View only ‚Ä¢ No login required"})]})]}),e.jsx("div",{children:!n&&e.jsxs("button",{onClick:H,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 text-sm font-medium",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"})}),"Login with Google"]})})]})}),e.jsx("div",{className:"pt-20 pb-8 px-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-3",children:t.title||"Untitled Snippet"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),new Date(t.timestamp).toLocaleString()]}),t.sourceType&&e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${t.sourceType==="user"?"bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200":t.sourceType==="assistant"?"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200":"bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200"}`,children:t.sourceType}),t.metadata&&e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),t.metadata.originalSize.toLocaleString()," chars",t.metadata.compressedSize&&e.jsxs("span",{className:"text-gray-400",children:["(",((1-t.metadata.compressedSize/t.metadata.originalSize)*100).toFixed(0),"% compressed)"]})]})]}),t.tags&&t.tags.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap mt-3",children:t.tags.map((d,o)=>e.jsxs("span",{className:"px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full",children:["#",d]},o))})]}),e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"prose dark:prose-invert max-w-none",children:e.jsx(J,{content:t.content})})})]}),e.jsx("div",{className:"mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"w-6 h-6 text-blue-600 dark:text-blue-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-blue-900 dark:text-blue-200 mb-1",children:"This is a shared snippet"}),e.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-300",children:["Someone shared this content with you. No login is required to view it.",!n&&e.jsx("span",{children:" Login to create an account and start using chat features."})]})]})]})})]})})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"Loading snippet..."})})};export{re as SharedSnippetViewer};


> lambdallmproxy@1.0.0 test
> jest

PASS tests/unit/tools-comprehensive.test.js
  Tools System - Comprehensive Coverage
    Tool Parameter Validation
      ✓ should handle all tool parameter combinations correctly (4 ms)
      ✓ should validate tool parameter types (1 ms)
    Tool Execution Edge Cases
      ✓ should handle extremely long queries gracefully (1 ms)
      ✓ should handle Unicode and special characters in queries (2 ms)
      ✓ should handle empty arrays in query parameter (1 ms)
      ✓ should handle very large limit values (1 ms)
    Tool Execution Error Handling
      ✓ should handle network timeouts gracefully (21 ms)
      ✓ should handle invalid URLs gracefully (1 ms)
      ✓ should handle cache errors gracefully (890 ms)
      ✓ should handle tool-specific errors (1 ms)
    Tool Execution Flow
      ✓ should execute tools in correct sequence
      ✓ should support multiple concurrent tool calls (1 ms)
      ✓ should maintain consistent error message format (2 ms)
    Tool Configuration Validation
      ✓ should validate tool function structure consistently (3 ms)
      ✓ should handle tool descriptions with special characters (1 ms)
      ✓ should validate parameter schemas are complete (1 ms)
    Integration with Other Modules
      ✓ should integrate properly with caching system (1 ms)
      ✓ should integrate with content optimization utilities (1 ms)
    Performance and Resource Management
      ✓ should not leak memory with many tool calls (1 ms)
      ✓ should handle large result sets without crashing (1 ms)
    Security and Sanitization
      ✓ should handle malicious JavaScript input safely (9 ms)
      ✓ should sanitize tool input parameters

PASS tests/unit/rag/sheets-storage.test.js
  SheetsStorage
    buildUserFilter
      ✓ should build proper user filter for Google Sheets queries (1 ms)
      ✓ should build filter with user email only when project is null (1 ms)
    validateProjectId
      ✓ should validate project ID format
    multi-tenancy isolation
      ✓ should use user and project in filter functions (1 ms)
      ✓ should isolate data by user and project in filter objects (1 ms)
    sheets-storage module exports
      ✓ should export required functions (1 ms)
    security validation
      ✓ should handle null user email by allowing it (validation happens elsewhere)

PASS tests/unit/endpoints/planning.test.js
  Planning Endpoint
    generatePlan
      ✓ should generate a valid plan from LLM response (312 ms)
      ✓ should throw error for empty query (14 ms)
      ✓ should throw error for missing API key (1 ms)
      ✓ should throw error for invalid LLM response format (1 ms)
      ✓ should throw error for invalid searchKeywords format (2 ms)
      ✓ should handle LLM errors gracefully (1 ms)
    handler
      ○ skipped should return 401 for missing authentication
      ○ skipped should return 401 for invalid token
      ○ skipped should return plan for valid authenticated request
      ○ skipped should return 400 for missing query
      ○ skipped should use env API key when available
      ○ skipped should return 500 for internal errors
      ○ skipped should include CORS headers

PASS tests/unit/model-selection-comprehensive.test.js
  Model Selection - Comprehensive Coverage
    Filter Functions
      ✓ should handle edge cases for filterByRateLimits (1 ms)
      ✓ should handle edge cases for filterByCost (1 ms)
      ✓ should handle edge cases for prioritizeFreeTier
      ✓ should handle edge cases for prioritizeQuality (1 ms)
      ✓ should handle edge cases for prioritizeCost (1 ms)
    RoundRobinSelector Edge Cases
      ✓ should handle key resets properly (1 ms)
      ✓ should handle multiple keys independently
      ✓ should handle invalid inputs gracefully (1 ms)
    selectModel Comprehensive Tests
      ✓ should handle very large context requirements (15 ms)
      ✓ should handle empty messages gracefully
      ✓ should handle null/undefined inputs gracefully (1 ms)
      ✓ should handle model selection with all parameters set (1 ms)
      ✓ should handle different token count calculations
      ✓ should not mutate original input data
      ✓ should handle rate limiting edge cases (1 ms)
      ✓ should handle multiple concurrent selections (1 ms)
    Fallback Logic Comprehensive
      ✓ should handle fallback for all categories (1 ms)
      ✓ should handle fallback selection with rate limits
      ✓ should test batch selection edge cases (1 ms)
    Performance and Robustness
      ✓ should handle high-volume selections without memory leaks (3 ms)
      ✓ should handle invalid model data gracefully
      ✓ should handle different strategy combinations (1 ms)
    Integration and Error Handling
      ✓ should provide meaningful error messages for various failure cases (1 ms)
      ✓ should validate all parameter combinations
      ✓ should maintain consistent return structure (1 ms)

PASS tests/unit/tools-advanced.test.js
  Tools System - Advanced Coverage
    Tool Function Structure Validation
      ✓ should validate all tool functions have consistent structure (4 ms)
      ✓ should handle different tool types and their parameters (1 ms)
      ✓ should validate tool parameter schemas are complete (1 ms)
    Advanced Tool Execution Scenarios
      ✓ should execute tools with complex parameter combinations (1 ms)
      ✓ should handle asynchronous tool execution properly (12 ms)
      ✓ should handle tool execution failures gracefully (1 ms)
    Tool Parameter Validation Edge Cases
      ✓ should validate parameters with special data types (1 ms)
      ✓ should handle large parameter objects
      ✓ should handle deeply nested parameter structures (1 ms)
    Memory and Performance Testing
      ✓ should not have memory leaks with repeated tool calls (2 ms)
      ✓ should handle rapid tool execution without conflicts (1 ms)
      ✓ should maintain performance with complex tool parameters (1 ms)
    Tool Integration and Composition
      ✓ should handle tool composition scenarios
      ✓ should validate merged tool configurations work correctly (1 ms)
      ✓ should handle complex tool parameters correctly
    Error Recovery and Robustness
      ✓ should recover gracefully from partial failures (1 ms)
      ✓ should handle invalid tool names gracefully
      ✓ should maintain consistency across different execution contexts (1 ms)

PASS tests/unit/streaming.test.js
  Streaming Modules
    SSE Writer
      StreamingResponse
        ✓ should accumulate SSE data (1 ms)
        ✓ should create empty stream initially (1 ms)
        ✓ should accumulate multiple writes in order
        ✓ should format event with type and data (1 ms)
        ✓ should handle complex nested objects
        ✓ should handle empty objects
        ✓ should handle null values in data (1 ms)
        ✓ should handle arrays as data
        ✓ should mix write and writeEvent calls
        ✓ should properly format SSE with double newlines (1 ms)
      createSSEStreamAdapter
        ✓ should create adapter with writeEvent method (2 ms)
        ✓ should handle write errors gracefully (4 ms)
        ✓ should handle write method errors gracefully (2 ms)
        ✓ should call underlying stream write with correct format (1 ms)
        ✓ should handle multiple sequential writes (1 ms)
        ✓ should handle multiple sequential events
        ✓ should preserve event type in formatted output (1 ms)
        ✓ should handle special characters in event data
        ✓ should handle empty event data (1 ms)
    Response Formatter
      formatJsonResponse
        ✓ should format JSON response with CORS headers
        ✓ should accept custom status code and headers (1 ms)
        ✓ should include CORS methods in headers
        ✓ should include CORS headers in custom responses
        ✓ should serialize complex objects correctly (1 ms)
        ✓ should handle null data
        ✓ should handle empty object
        ✓ should merge additional headers with defaults (1 ms)
        ✓ should handle various HTTP status codes
      formatStreamingResponse
        ✓ should format SSE response (1 ms)
        ✓ should include keep-alive header (1 ms)
        ✓ should include transfer encoding header (1 ms)
        ✓ should include CORS headers
        ✓ should handle empty body (1 ms)
        ✓ should handle multiple SSE events in body
        ✓ should accept custom status code
      formatErrorResponse
        ✓ should format error response (1 ms)
        ✓ should default to 500 status code
        ✓ should include timestamp in ISO format (1 ms)
        ✓ should include additional context
        ✓ should handle various error status codes
        ✓ should include CORS headers (1 ms)
        ✓ should be valid JSON
      formatCORSResponse
        ✓ should format CORS preflight response
        ✓ should allow Content-Type and Authorization headers (1 ms)
        ✓ should allow GET, POST, OPTIONS methods
        ✓ should have empty body
        ✓ should cache preflight for 24 hours (1 ms)

PASS tests/unit/json-parser.test.js
  Robust JSON Parser
    robustJsonParse
      ✓ parses clean JSON (1 ms)
      ✓ parses JSON with markdown code fence
      ✓ parses JSON with plain code fence (1 ms)
      ✓ parses JSON with trailing commas
      ✓ parses JSON with trailing commas in array
      ✓ extracts JSON object from text (1 ms)
      ✓ extracts JSON array from text
      ✓ handles single quotes (converts to double) (1 ms)
      ✓ removes JavaScript comments
      ✓ handles nested objects
      ✓ handles nested arrays (1 ms)
      ✓ throws error on invalid JSON after all attempts (4 ms)
      ✓ throws error on empty string (1 ms)
      ✓ throws error on null input
    tryParseJson
      ✓ returns parsed JSON on success
      ✓ returns null on failure (1 ms)
      ✓ returns null without throwing
    extractAllJson
      ✓ extracts multiple JSON objects (1 ms)
      ✓ extracts JSON arrays if no objects found
      ✓ returns empty array if no JSON found
    validateJsonSchema
      ✓ validates required fields (1 ms)
      ✓ fails when required field missing
      ✓ validates field types (1 ms)
      ✓ fails on incorrect type
      ✓ validates object type
      ✓ fails when array expected but object provided (1 ms)
      ✓ returns false for non-object input
    Real-world LLM response scenarios
      ✓ handles typical GPT response with code fence
      ✓ handles response with extra explanatory text (1 ms)
      ✓ handles malformed JSON from streaming accumulation
      ✓ handles quiz-like structure
      ✓ handles feed item structure (1 ms)

PASS tests/unit/search.test.js (68.981 s)
  DuckDuckGoSearcher
    search
      ✓ should return search results for valid query (10714 ms)
      ✓ should handle search errors by throwing (20 ms)
      ✓ should respect timeout parameter (5509 ms)
      ✓ should limit results to specified count (11137 ms)
    memory tracking
      ✓ should track memory usage during search (11129 ms)
    Anti-blocking Features
      Request Spacing
        ✓ should enforce minimum request interval (700 ms)
        ✓ should apply exponential backoff on failures (4456 ms)
      Circuit Breaker
        ✓ should open circuit breaker after max failures (1141 ms)
        ✓ should reject requests when circuit breaker is open (2 ms)
        ✓ should close circuit breaker after timeout (11111 ms)
      Request Tracking
        ✓ should track successful requests (11407 ms)
        ✓ should track failed requests (3 ms)
        ✓ should limit request history size (1 ms)
      Enhanced User Agent Rotation
        ✓ should use different browser fingerprints (12 ms)
      CAPTCHA Detection
        ✓ should detect and track CAPTCHA responses (2 ms)
      Session Management
        ✓ should initialize session state correctly (2 ms)
        ✓ should handle rapid consecutive requests with spacing (1604 ms)

PASS tests/unit/tools.test.js
  Tools System
    Tool Registry (toolFunctions)
      ✓ should export array of tool functions (1 ms)
      ✓ all tools should have required structure (5 ms)
      ✓ tool names should be unique
      ✓ should include critical tools (1 ms)
      ✓ search_web tool should have correct parameters (1 ms)
      ✓ execute_javascript tool should have code parameter
    getToolFunctions()
      ✓ should return all tools when no filter (1 ms)
      ✓ should return tools array with OpenAI-compatible format (1 ms)
    Tool Execution - search_web
      ✓ should execute search_web with single query (1 ms)
      ✓ should handle array of queries (1 ms)
      ✓ should return error for missing query (1 ms)
      ✓ should emit progress events
      ✓ should use Tavily when API key provided (1 ms)
      ✓ should respect limit parameter (1 ms)
      ✓ should clamp timeout values to valid range
      ✓ should handle multiple queries in single call (1 ms)
    Tool Execution - execute_javascript
      ✓ should execute simple JavaScript code (5 ms)
      ✓ should capture console.log output (2 ms)
      ✓ should return execution result (1 ms)
      ✓ should handle errors gracefully (2 ms)
      ✓ should handle syntax errors (1 ms)
      ✓ should respect timeout parameter (1003 ms)
      ✓ should handle Math operations (1 ms)
      ✓ should handle array operations (2 ms)
      ✓ should not have access to require() (1 ms)
      ✓ should not have access to global process (1 ms)
    Tool Execution - scrape_web_content
      ✓ should require URL parameter
      ✓ should validate URL is not empty string (2 ms)
      ✓ should return cached content when available
      ✓ should handle timeout parameter validation (730 ms)
    Tool Execution - transcribe_url
      ✓ should require URL parameter (1 ms)
      ✓ should require API key for Whisper transcription (1 ms)
      ✓ should reject Gemini API keys for transcription
      ✓ should detect YouTube URLs and require OAuth when Whisper disabled (1 ms)
    Parameter Validation
      ✓ should clamp limit parameter to valid range
      ✓ should handle missing required parameters (1 ms)
      ✓ should handle invalid parameter types
      ✓ should handle empty string parameters (1 ms)
    compressSearchResultsForLLM()
      ✓ should compress results into markdown format (1 ms)
      ✓ should handle empty results
      ✓ should handle null results (1 ms)
      ✓ should format multiple results
      ✓ should strip markdown formatting from content (1 ms)
    Unknown Tool Handling
      ✓ should return error for unknown tool (1 ms)
      ✓ should handle empty string tool name
    Context Propagation
      ✓ should pass context to tool execution (1 ms)
      ✓ should use optimization context for result count (1 ms)
    Error Handling
      ✓ should handle search errors gracefully (23 ms)
      ✓ should handle invalid JavaScript execution (1 ms)
      ✓ should require parameters for tools

PASS tests/integration/image-search-feed.test.js
  Image Search Feed Integration
    extractImagesFromSearchResults
      ✓ should extract images from search result metadata (1 ms)
      ✓ should filter out junk images
      ✓ should extract images from HTML content
    Feed item image priority
      ✓ should prioritize web search images over API images
    Image source attribution
      ✓ should properly attribute web search images
      ✓ should properly attribute API images

PASS tests/unit/retry-handler.test.js
  RetryHandler
    Successful Requests
      ✓ should return result on first successful attempt (1 ms)
      ✓ should not retry on success (1 ms)
    Retry Logic
      ✓ should retry on rate limit error (429)
      ✓ should retry on server errors (5xx)
      ✓ should retry on network errors (1 ms)
      ✓ should not retry on client errors (4xx except 429) (5 ms)
      ✓ should not retry on auth errors (401)
    Retry Attempts
      ✓ should respect max retry limit (1 ms)
      ✓ should succeed on last retry attempt (1 ms)
      ✓ should use custom max retries
    Backoff Strategy
      ✓ should apply exponential backoff between retries (1 ms)
      ✓ should use retry-after header when available (1 ms)
      ✓ should cap delay at maximum
    Error Classification
      ✓ should classify errors before retry decision (1 ms)
      ✓ should respect classifier retryable decision (1 ms)
    Error Context
      ✓ should preserve error information
      ✓ should include retry metadata in final error (1 ms)
      ✓ should track all errors from retry attempts (1 ms)
    Request Execution
      ✓ should pass arguments to request executor
      ✓ should support async request executors (13 ms)
      ✓ should handle promise rejections (1 ms)
    Retry Callbacks
      ✓ should call onRetry callback before each retry (1 ms)
      ✓ should call onSuccess callback after successful request
      ✓ should call onFailure callback after all retries exhausted (1 ms)
    Edge Cases
      ✓ should handle executor returning null (1 ms)
      ✓ should handle errors without code property
      ✓ should handle synchronous executor functions (1 ms)
      ✓ should handle zero max retries (945 ms)

PASS tests/unit/providers/provider-errors.test.js
  Provider Error Handling
    Error Standardization
      ✓ should standardize basic errors (2 ms)
      ✓ should preserve error codes (1 ms)
      ✓ should include context in errors
      ✓ should handle errors without messages (1 ms)
    Rate Limit Errors
      ✓ should detect rate limit from status code (1 ms)
      ✓ should detect rate limit from message
      ✓ should preserve original rate limit error info
    Authentication Errors
      ✓ should detect 401 unauthorized errors (1 ms)
      ✓ should detect 403 forbidden errors
      ✓ should mark auth errors as non-retryable (1 ms)
    Timeout Errors
      ✓ should detect ETIMEDOUT errors
      ✓ should detect timeout from message (1 ms)
      ✓ should mark timeout errors as retryable
    Network Errors
      ✓ should detect ECONNREFUSED errors (2 ms)
      ✓ should detect ENOTFOUND errors
      ✓ should mark network errors as retryable (1 ms)
    Provider-Specific Error Info
      ✓ should include provider type in errors
      ✓ should include provider ID in errors (1 ms)
      ✓ should preserve original error for debugging
    Error Context
      ✓ should include request context in errors
      ✓ should handle empty context (1 ms)
      ✓ should handle missing context
    Real Provider Error Handling
      ✓ should handle OpenAI provider errors (554 ms)
      ✓ should handle Groq provider errors (272 ms)
    Error Recovery
      ✓ should identify retryable errors (1 ms)
      ✓ should not mark unknown errors as retryable (3 ms)

PASS tests/integration/lambda-metrics.test.js
  Lambda Metrics Integration
    Chat Endpoint
      ✓ should extract Lambda metrics from context and pass to logging (306 ms)
    RAG Endpoint
      ✓ should extract Lambda metrics from context in RAG handler (90 ms)
    Planning Endpoint
      ✓ should extract Lambda metrics from context in planning handler (3 ms)
    Google Sheets Logger
      ✓ should accept Lambda metrics fields in logToGoogleSheets
      ✓ should handle missing Lambda metrics gracefully (1 ms)
    Memory Usage Calculation
      ✓ should calculate memory usage in MB with proper precision

PASS tests/unit/pricing.test.js
  Pricing Module
    Pricing Data Loading
      ✓ should load pricing data for all providers (1 ms)
      ✓ should have pricing for common OpenAI models (255 ms)
      ✓ should have pricing for common Groq models (211 ms)
    Cost Calculations
      ✓ should calculate OpenAI GPT-4o cost correctly (1 ms)
      ✓ should calculate Groq Llama cost correctly (1 ms)
      ✓ should handle unknown provider
      ✓ should handle unknown model (1 ms)
      ✓ should handle case insensitive provider names (2 ms)

PASS tests/integration/feed-recommendations.test.js
  Feed Recommender - TF-IDF with Quiz Engagement
    Keyword Extraction with Quiz Weighting
      ✓ should extract keywords using TF-IDF (2 ms)
      ✓ should weight quiz-generated items 2x higher
      ✓ should weight high-scoring quizzes (>80%) 3x higher (1 ms)
    Topic Extraction with Quiz Engagement
      ✓ should extract topics with frequency and recency (1 ms)
      ✓ should boost topics with quiz engagement (4 ms)
      ✓ should track average quiz score per topic
    Avoid Topics from Trash
      ✓ should extract topics to avoid from trashed items
      ✓ should require 3+ trashes to avoid topic
    Search Term Generation
      ✓ should generate 60% keywords, 20% topics, 20% trending (1 ms)
      ✓ should filter out avoided topics (1 ms)
      ✓ should provide default terms for new users
    Preference Learning from Interactions
      ✓ should analyze mixed interactions correctly (1 ms)
      ✓ should handle empty interactions gracefully (1 ms)
    Performance
      ✓ should analyze preferences in < 200ms (3 ms)

PASS tests/unit/load-balancer.test.js
  LoadBalancer
    Round-Robin Distribution
      ✓ should distribute requests evenly across providers (1 ms)
      ✓ should maintain separate round-robin state per provider type (1 ms)
      ✓ should reset to start after reaching end (1 ms)
    Rate Limit Aware Distribution
      ✓ should skip rate-limited providers
      ✓ should return null when all providers are rate-limited (1 ms)
      ✓ should resume using provider after rate limit expires (153 ms)
    Single Provider Scenarios
      ✓ should return same provider when only one available (1 ms)
      ✓ should handle empty provider list
    Token Estimation
      ✓ should pass token estimate to rate limit check
    State Management
      ✓ should maintain state across multiple calls (1 ms)
      ✓ should allow resetting round-robin state
    Error Handling
      ✓ should handle invalid provider list (1 ms)
      ✓ should handle missing model ID

PASS tests/unit/rate-limit-tracker.test.js
  ModelRateLimit
    Constructor
      ✓ should initialize with default limits (1 ms)
      ✓ should initialize with custom limits (1 ms)
      ✓ should initialize tracking fields
    canMakeRequest
      ✓ should allow request when under limits (1 ms)
      ✓ should block when request limit reached
      ✓ should block when token limit would be exceeded
      ✓ should block when unavailable due to 429
      ✓ should allow request after unavailable period expires (154 ms)
      ✓ should block when daily limit reached
    trackRequest
      ✓ should increment request counter (1 ms)
      ✓ should increment token counter
      ✓ should add to history
      ✓ should handle zero tokens (1 ms)
    updateFromHeaders
      ✓ should update from x-ratelimit headers
      ✓ should handle missing headers gracefully (1 ms)
      ✓ should parse reset timestamp in seconds
      ✓ should parse reset timestamp in milliseconds
      ✓ should parse reset as seconds until reset (1 ms)
      ✓ should handle invalid header values
    updateFrom429
      ✓ should set unavailableUntil with retry-after
      ✓ should default to 60 seconds when no retry-after (1 ms)
      ✓ should block requests until unavailable period expires
    getCapacity
      ✓ should return available capacity
      ✓ should return zero capacity when unavailable (1 ms)
      ✓ should return Infinity for unlimited resources
    reset
      ✓ should not reset counters before time expires (1 ms)
      ✓ should reset minute counters after 60 seconds
      ✓ should reset daily counters after 24 hours
    cleanHistory
      ✓ should remove old history entries
      ✓ should recalculate usage from history (2 ms)
    parseHeader
      ✓ should parse valid numbers (1 ms)
      ✓ should return null for invalid values
  RateLimitTracker
    Constructor
      ✓ should initialize empty tracker
      ✓ should disable auto-reset when configured (1 ms)
      ✓ should accept persistence option
    getModelLimit
      ✓ should create new model limit if not exists (1 ms)
      ✓ should return existing model limit
      ✓ should create separate limits for different providers
      ✓ should use custom limits when provided
    trackRequest
      ✓ should track request for model (1 ms)
      ✓ should create model limit if not exists
      ✓ should call reset when autoReset enabled
      ✓ should not call reset when autoReset disabled (1 ms)
      ✓ should persist state when persistence configured
    updateFromHeaders
      ✓ should update model limit from headers
      ✓ should persist state after update (1 ms)
    updateFrom429
      ✓ should mark model as unavailable
      ✓ should use default retry time when not specified
      ✓ should persist state after 429 (1 ms)
    isAvailable
      ✓ should return true for untracked provider
      ✓ should return true for untracked model
      ✓ should return false when rate limited (1 ms)
      ✓ should return false when unavailable due to 429
      ✓ should check token requirements
    getCapacity
      ✓ should return infinite capacity for untracked model (2 ms)
      ✓ should return actual capacity for tracked model
    resetLimits
      ✓ should reset all providers when no arguments
      ✓ should reset all models for provider (1 ms)
      ✓ should reset specific model
      ✓ should persist state after reset
    getProviders
      ✓ should return empty array for new tracker
      ✓ should return all tracked providers
    getModels
      ✓ should return empty array for untracked provider
      ✓ should return all tracked models for provider (1 ms)
    Serialization
      ✓ should serialize to JSON
      ✓ should deserialize from JSON (1 ms)
      ✓ should handle invalid JSON gracefully
      ✓ should round-trip serialize/deserialize (1 ms)
    Persistence
      ✓ should persist after tracking
      ✓ should load state on initialization
      ✓ should handle persistence without save method (1 ms)
      ✓ should handle persistence without load method

PASS tests/unit/model-selector.test.js
  SelectionStrategy
    ✓ should define all strategies (1 ms)
  filterByRateLimits
    ✓ should return all models when no tracker
    ✓ should filter out rate-limited models (1 ms)
    ✓ should check token requirements
  filterByCost
    ✓ should return all models when no constraint
    ✓ should filter by cost constraint (1 ms)
    ✓ should calculate average of input and output
  prioritizeFreeTier
    ✓ should put free models first
    ✓ should maintain order within tiers
    ✓ should handle all free models (2 ms)
    ✓ should handle no free models
  prioritizeQuality
    ✓ should sort by context window descending (1 ms)
    ✓ should not mutate original array
  prioritizeCost
    ✓ should sort by cost ascending
    ✓ should put cheapest model first (1 ms)
    ✓ should not mutate original array
  RoundRobinSelector
    ✓ should initialize with empty state
    ✓ should select first model initially (1 ms)
    ✓ should rotate through models
    ✓ should handle single model
    ✓ should return null for empty array (1 ms)
    ✓ should track separate keys independently
    ✓ should reset specific key
    ✓ should reset all keys
  selectModel
    ✓ should throw when catalog is empty (9 ms)
    ✓ should throw when messages are empty
    ✓ should select model for simple request (2 ms)
    ✓ should select model for complex request
    ✓ should select model for reasoning request (1 ms)
    ✓ should filter by context window (1 ms)
    ✓ should throw when no models have sufficient context (17 ms)
    ✓ should respect rate limits (2 ms)
    ✓ should throw when all models are rate limited (1 ms)
    ✓ should respect cost constraint
    ✓ should throw when no models within cost constraint (1 ms)
    ✓ should apply FREE_TIER strategy
    ✓ should apply COST_OPTIMIZED strategy
    ✓ should apply QUALITY_OPTIMIZED strategy (1 ms)
    ✓ should apply BALANCED strategy
    ✓ should throw for unknown strategy
    ✓ should use round-robin when provided (1 ms)
    ✓ should include metadata in result
    ✓ should handle tools in request (1 ms)
    ✓ should respect max_tokens parameter
  getFallbackCategories
    ✓ should provide fallbacks for REASONING
    ✓ should provide fallbacks for LARGE (1 ms)
    ✓ should provide fallbacks for SMALL
    ✓ should handle unknown category (1 ms)
  selectWithFallback
    ✓ should return primary selection when available
    ✓ should fallback when primary category rate limited
    ✓ should throw when all fallbacks exhausted (1 ms)
  batchSelect
    ✓ should throw for non-array input (1 ms)
    ✓ should select models for multiple requests
    ✓ should use round-robin across requests (2 ms)
    ✓ should handle errors gracefully (1 ms)
    ✓ should handle empty array

PASS tests/integration/model-selection.test.js
  Model Selection Integration Tests
    Simple Request Flow
      ✓ should select small free model for simple request (1 ms)
      ✓ should estimate tokens correctly for simple request (1 ms)
      ✓ should include analysis in result
    Complex Request Flow
      ✓ should select large model for complex request
      ✓ should handle multi-turn conversations (2 ms)
      ✓ should estimate higher tokens for long conversation (1 ms)
    Reasoning Request Flow
      ✓ should select reasoning model for reasoning keywords
      ✓ should detect reasoning from analyze keyword (1 ms)
    Rate Limit Integration
      ✓ should skip rate-limited models
      ✓ should use rate limit info in selection (1 ms)
      ✓ should throw when all models are rate-limited (8 ms)
    Cost Optimization
      ✓ should prefer free models over paid
      ✓ should respect cost constraint (1 ms)
      ✓ should use cost_optimized strategy
    Fallback Scenarios
      ✓ should fallback from small to large when rate-limited (1 ms)
      ✓ should try multiple fallback categories
    Batch Processing
      ✓ should process multiple requests (1 ms)
      ✓ should handle mix of request types in batch
    Context Window Handling
      ✓ should filter models by context window requirement (1 ms)
      ✓ should throw when no model has sufficient context (13 ms)
    Edge Cases
      ✓ should handle empty message content gracefully (1 ms)
      ✓ should handle special characters in messages
      ✓ should handle max_tokens parameter (1 ms)
      ✓ should handle system messages in conversation
    Performance
      ✓ should complete selection quickly (1 ms)
      ✓ should handle large batch efficiently (1 ms)

PASS tests/integration/guardrails-auto-detection.test.js
  Guardrails Integration
    End-to-End Flow
      ✓ should complete config and validator creation with groq-free (2 ms)
      ✓ should work with indexed provider format
      ✓ should skip guardrails when disabled
      ✓ should skip guardrails when no provider available (2 ms)
      ✓ should prefer context over environment variables
      ✓ should fallback through provider priority (1 ms)
    Cost Tracking
      ✓ should create validator with tracking capabilities (1 ms)
    Error Handling
      ✓ should handle missing provider gracefully
      ✓ should throw when config specifies unavailable provider (5 ms)
    Indexed Provider Format
      ✓ should work with indexed provider environment variables

PASS tests/unit/providers/provider-system.test.js
  Provider System
    BaseProvider
      ✓ should not allow direct instantiation (5 ms)
      ✓ should store configuration
      ✓ should use default values for optional config (1 ms)
      ✓ should require subclass to implement getEndpoint
      ✓ should require subclass to implement getHeaders (1 ms)
      ✓ should require subclass to implement buildRequestBody
      ✓ should require subclass to implement makeRequest (1 ms)
      ✓ should require subclass to implement streamRequest
      ✓ should require subclass to implement getSupportedModels (1 ms)
      ✓ should provide default parseRateLimits implementation
      ✓ should allow overriding parseRateLimits (1 ms)
    ProviderFactory
      ✓ should create OpenAI provider
      ✓ should create Groq provider (1 ms)
      ✓ should handle unknown provider type
      ✓ should require apiKey for provider creation (1 ms)
      ✓ should pass configuration to created provider
    Provider Request Formatting
      ✓ should format basic chat messages (3 ms)
      ✓ should include tools in request body
      ✓ should handle max_tokens parameter (1 ms)
      ✓ should handle stream parameter
    Provider Headers
      ✓ should include API key in OpenAI headers
      ✓ should include API key in Groq headers
    Provider Endpoints
      ✓ should return OpenAI endpoint
      ✓ should return Groq endpoint
      ✓ should use custom endpoint if provided
    Supported Models
      ✓ OpenAI provider should support GPT models
      ✓ Groq provider should support Groq models
      ✓ should check if specific model is supported (1 ms)
    Token Estimation
      ✓ should estimate tokens for messages
      ✓ should estimate more tokens for longer content
      ✓ should handle empty messages (1 ms)

PASS tests/unit/model-formats.test.js
  Model Format Registry
    MODEL_FORMATS
      ✓ should include gpt-oss-20b configuration
      ✓ should include gpt-oss-120b configuration
      ✓ should have description for each model
    getModelFormat
      ✓ should return format for gpt-oss models (1 ms)
      ✓ should return null for models without special formatting
      ✓ should return null for undefined model
    requiresCleaning
      ✓ should return true for gpt-oss models (1 ms)
      ✓ should return false for standard models
      ✓ should return false for undefined model
    getModelsRequiringCleaning
      ✓ should return array of models requiring cleaning (1 ms)
      ✓ should only return models with requiresCleaning: true
  Content Cleaning Functions
    cleanModelContent
      ✓ should remove <function=name> tags (1 ms)
      ✓ should remove complete XML function calls
      ✓ should remove self-closing XML tags
      ✓ should remove JSON-like objects in XML (1 ms)
      ✓ should handle multiple Claude-style tags in one message
      ✓ should clean up excessive whitespace after removing tags
      ✓ should trim leading and trailing whitespace (1 ms)
      ✓ should return original content for models not requiring cleaning
      ✓ should handle empty strings
      ✓ should handle null/undefined content (2 ms)
      ✓ should preserve valid markdown and HTML (1 ms)
      ✓ should handle multiline XML function calls
    cleanStreamingChunk
      ✓ should clean chunks with Claude syntax
      ✓ should handle partial tags in streaming (1 ms)
      ✓ should return original chunk for models not requiring cleaning
      ✓ should handle empty chunks
      ✓ should handle null/undefined chunks
  Dynamic Registration
    registerModelFormat
      ✓ should allow registering new model format (1 ms)
      ✓ should throw error if model is missing (4 ms)
      ✓ should throw error if config is missing
      ✓ should throw error if requiresCleaning is not boolean (1 ms)
      ✓ should throw error if cleaningPatterns is not array
      ✓ should allow overriding existing model format
  Real-World Scenarios
    Claude syntax patterns from gpt-oss models
      ✓ should clean typical search web pattern (1 ms)
      ✓ should clean typical execute javascript pattern
      ✓ should clean typical scrape url pattern
      ✓ should handle mixed valid content with Claude syntax
      ✓ should preserve actual tool call responses (JSON)
    Edge cases and corner cases
      ✓ should handle malformed XML tags
      ✓ should handle nested tags (1 ms)
      ✓ should handle tags with special characters
      ✓ should handle very long content efficiently (2 ms)

PASS tests/integration/system_prompt_optimization.test.js
  System Prompt Optimization - Critical Rules Preservation
    Tool Usage Rules
      ✓ should mention all 4 tools (1 ms)
      ✓ should specify strict parameter requirements
      ✓ should emphasize YouTube tool priority (1 ms)
      ✓ should mention multi-query search support
      ✓ should warn against XML/text syntax (at least once)
      ✓ should NOT have excessive repetition of XML warnings (1 ms)
    Response Quality Rules
      ✓ should specify target response length (1000-3000 words)
      ✓ should mention markdown formatting
      ✓ should emphasize completeness checking (1 ms)
      ✓ should encourage using tools when needed
      ✓ should mention proper structure (overview, details, examples)
    Temporal Information Rules
      ✓ should inject current date/time (1 ms)
      ✓ should warn against guessing dates (1 ms)
      ✓ should mention execute_javascript for date calculations
    Optimization Metrics
      ✓ should be significantly shorter than original (target: <2500 tokens)
      ✓ should have reduced emphasis markers (CRITICAL/NEVER) (1 ms)
      ✓ should have no emojis
      ✓ should not have excessive examples section
    No Functional Loss
      ✓ should still have OpenAI function calling mention (1 ms)
      ✓ should still specify all tool parameters
      ✓ should still warn about brief responses
      ✓ should still mention citing sources (1 ms)
  System Prompt Structure Validation
    ✓ should have clear sections (TOOLS, RESPONSE, etc.)
    ✓ should start with a clear AI assistant description (1 ms)
    ✓ should have date/time near the beginning
    ✓ should not have excessive whitespace or line breaks
  Token Estimation
    ✓ should estimate tokens correctly
  Critical Rules Checklist
    ✓ CRITICAL RULE: Tool parameter restrictions (additionalProperties: false) (1 ms)
    ✓ CRITICAL RULE: Date/time handling (use provided, never guess)
    ✓ CRITICAL RULE: YouTube priority (search_youtube for videos)
    ✓ CRITICAL RULE: Multi-query support (array of queries) (1 ms)
    ✓ CRITICAL RULE: Response format (Markdown with headings, lists, code)
    ✓ CRITICAL RULE: Completeness check before finalizing
    ✓ CRITICAL RULE: Comprehensive response length (1000-3000 words)
    ✓ CRITICAL RULE: Tool usage when helpful (1 ms)
  Removed Redundancies Validation
    ✓ should not have 8+ NEVER statements
    ✓ should not have 12+ CRITICAL statements (2 ms)
    ✓ should not have emojis
    ✓ should not have verbose example categories
    ✓ should not have excessive transitional phrases (1 ms)
    ✓ should not have redundant temporal sections
    ✓ should not have explicit markdown instruction lists
  Output Format
    ✓ should print optimization summary (2 ms)

PASS tests/unit/request-analyzer.test.js
  RequestType Constants
    ✓ should define all request types (1 ms)
  Pattern Constants
    ✓ should define reasoning patterns (3 ms)
    ✓ should define complex patterns
    ✓ should define creative patterns
    ✓ should define tool patterns (1 ms)
  countPatternMatches
    ✓ should count matching patterns
    ✓ should return 0 for no matches
    ✓ should handle empty content (1 ms)
    ✓ should handle null/undefined content
    ✓ should be case insensitive
  detectRequestType
    REASONING type detection
      ✓ should detect math problems
      ✓ should detect logic problems (1 ms)
      ✓ should detect code debugging
      ✓ should detect step-by-step requests
      ✓ should detect "why" questions (1 ms)
    TOOL_HEAVY type detection
      ✓ should detect multiple tool indicators
      ✓ should detect web scraping requests
      ✓ should not trigger on single tool mention (1 ms)
    COMPLEX type detection
      ✓ should detect detailed explanation requests
      ✓ should detect research requests
      ✓ should detect planning requests (1 ms)
      ✓ should detect multiple approaches requests
    CREATIVE type detection
      ✓ should detect story writing
      ✓ should detect poetry requests
      ✓ should detect brainstorming
      ✓ should detect fictional content
    SIMPLE type detection
      ✓ should detect short queries (2 ms)
      ✓ should detect greetings
      ✓ should detect basic facts
    Length-based detection
      ✓ should default to simple for short content (1 ms)
      ✓ should default to complex for long content without patterns
    Edge cases
      ✓ should handle empty string
      ✓ should handle null
      ✓ should handle undefined (1 ms)
      ✓ should handle non-string input
  analyzeMessages
    ✓ should analyze single user message
    ✓ should focus on last user message (1 ms)
    ✓ should ignore assistant messages when finding last user message
    ✓ should handle empty messages array
    ✓ should handle null messages
    ✓ should handle messages without user role (1 ms)
    ✓ should handle messages with empty content
  requiresLargeContext
    ✓ should detect large context from message length
    ✓ should detect large context from multiple messages (1 ms)
    ✓ should not flag small contexts
    ✓ should use custom threshold
    ✓ should handle empty messages
    ✓ should handle null messages (1 ms)
  requiresReasoning
    ✓ should return true for reasoning requests
    ✓ should return false for simple requests
    ✓ should handle empty messages (1 ms)
  isToolHeavy
    ✓ should return true for tool-heavy requests with tools available
    ✓ should return false when no tools available
    ✓ should return false for non-tool-heavy requests
    ✓ should handle empty messages (2 ms)
  estimateConversationDepth
    ✓ should count single turn
    ✓ should count multiple turns
    ✓ should handle consecutive messages from same role (1 ms)
    ✓ should ignore system messages
    ✓ should handle empty messages
    ✓ should handle null messages
  analyzeRequest
    ✓ should provide comprehensive analysis for simple request (1 ms)
    ✓ should provide comprehensive analysis for reasoning request
    ✓ should provide comprehensive analysis for complex request (1 ms)
    ✓ should detect tool-heavy requests
    ✓ should detect large context requirements (1 ms)
    ✓ should handle multi-turn conversations
    ✓ should handle empty options (1 ms)
    ✓ should handle missing options
  getComplexityScore
    ✓ should score simple requests low
    ✓ should score reasoning requests high
    ✓ should increase score with conversation depth (1 ms)
    ✓ should increase score for large context
    ✓ should cap score at 10
    ✓ should return integer scores

PASS tests/unit/html-extraction.test.js
  HTML Content Extractor
    htmlToMarkdown
      ✓ should convert headings to Markdown (2 ms)
      ✓ should convert lists to Markdown (1 ms)
      ✓ should convert links to Markdown
      ✓ should convert code blocks (1 ms)
      ✓ should convert inline code
      ✓ should convert emphasis
      ✓ should remove script tags (1 ms)
      ✓ should remove style tags
      ✓ should remove navigation elements (1 ms)
      ✓ should decode HTML entities
      ✓ should resolve relative URLs to absolute URLs
      ✓ should handle protocol-relative URLs (1 ms)
      ✓ should preserve anchor and special links
    htmlToText
      ✓ should extract plain text from HTML (1 ms)
      ✓ should remove scripts and styles (2 ms)
      ✓ should preserve newlines between elements
    extractMainContent
      ✓ should extract content from main tag (1 ms)
      ✓ should extract content from article tag (1 ms)
      ✓ should extract content from common content classes
      ✓ should return full HTML if no main content found (1 ms)
    extractContent
      ✓ should return markdown format for well-structured HTML
      ✓ should include compression ratio
      ✓ should handle empty HTML gracefully (1 ms)
      ✓ should fallback to text when markdown extraction is poor
      ✓ should handle malformed HTML (1 ms)
      ✓ should extract content from complex real-world HTML
      ✓ should preserve links in markdown format
    Token efficiency
      ✓ should significantly reduce token count

PASS tests/integration/lambda-handler-comprehensive.test.js
  Lambda Handler - Comprehensive Integration Tests
    Request Validation and Processing
      ✓ should validate all required request parameters (1 ms)
      ✓ should handle malformed JSON requests
      ✓ should validate HTTP method correctly (3 ms)
    Authentication and Authorization
      ✓ should handle different authentication scenarios (1 ms)
      ✓ should validate access secrets properly (1 ms)
    Error Handling and Response Generation
      ✓ should generate appropriate error responses for different failure modes (1 ms)
      ✓ should maintain proper response structure for valid requests (1 ms)
    Performance and Resource Usage
      ✓ should handle multiple rapid requests without crashing (1 ms)
      ✓ should process requests with different content types (1 ms)
    Security and Input Sanitization
      ✓ should handle malicious input gracefully (1 ms)
    Edge Cases and Boundary Conditions
      ✓ should handle empty and null values gracefully (1 ms)
      ✓ should handle very long queries (1 ms)

PASS tests/unit/services/user-isolation.test.js
  User Isolation Utilities
    validateUserEmail
      ✓ should accept valid email (1 ms)
      ✓ should reject null email (3 ms)
      ✓ should reject undefined email (1 ms)
      ✓ should reject empty string
      ✓ should reject whitespace-only string (1 ms)
      ✓ should reject "unknown" placeholder
      ✓ should reject "anonymous" placeholder
    buildUserFilter
      ✓ should build filter with user email only (1 ms)
      ✓ should build filter with user email and project ID
      ✓ should ignore null project ID (1 ms)
      ✓ should ignore empty project ID (1 ms)
    extractProjectId
      ✓ should extract x-project-id header (lowercase)
      ✓ should extract X-Project-ID header (uppercase)
      ✓ should return null for missing headers (1 ms)
      ✓ should return null for null event
    filterByUserAndProject
      ✓ should filter by user email only
      ✓ should filter by user email and project ID (3 ms)
      ✓ should return empty array for non-existent user
      ✓ should not leak data across users
    belongsToUser
      ✓ should return true for matching user (1 ms)
      ✓ should return false for non-matching user
      ✓ should return false for null row
    createUnauthorizedResponse
      ✓ should create 403 response with default message (1 ms)
      ✓ should create 403 response with custom message
    createUnauthenticatedResponse
      ✓ should create 401 response
    logUserAccess
      ✓ should log user access (1 ms)

PASS tests/unit/html-parser.test.js
  SimpleHTMLParser
    Constructor and Initialization
      ✓ should initialize with HTML and query (1 ms)
      ✓ should handle empty query
      ✓ should filter out short query words
      ✓ should normalize query to lowercase (1 ms)
    Relevance Scoring
      ✓ should calculate relevance based on query word matches
      ✓ should return 0 for no query words
      ✓ should return 0 for empty text
      ✓ should give bonus for title/heading patterns
      ✓ should be case-insensitive for word matching
      ✓ should count multiple word matches (1 ms)
      ✓ should clamp score to maximum 1.0
    Media Type Detection
      ✓ should detect YouTube watch URLs (1 ms)
      ✓ should detect youtu.be short URLs
      ✓ should detect YouTube embed URLs
      ✓ should detect YouTube Shorts
      ✓ should NOT detect YouTube playlists as videos
      ✓ should NOT detect YouTube channels as videos
      ✓ should detect video file extensions (1 ms)
      ✓ should detect audio file extensions (2 ms)
      ✓ should detect streaming service URLs
      ✓ should return null for regular URLs
      ✓ should handle URLs with query parameters (1 ms)
    Image Extraction
      ✓ should extract images with src attribute (1 ms)
      ✓ should skip data URIs (1 ms)
      ✓ should skip tracking pixels
      ✓ should extract alt and title attributes
      ✓ should extract image dimensions (1 ms)
      ✓ should prefer larger images (quality scoring)
      ✓ should respect limit parameter
      ✓ should calculate relevance scores (1 ms)
      ✓ should extract figcaption as caption
    Link Extraction
      ✓ should extract links with href and text (1 ms)
      ✓ should filter out navigation links (1 ms)
      ✓ should filter out javascript: and mailto: links
      ✓ should filter out anchor-only links
      ✓ should filter out ad domains (1 ms)
      ✓ should filter out very short links
      ✓ should filter out very long link text
      ✓ should calculate relevance scores (1 ms)
      ✓ should boost links with substantial text
      ✓ should penalize links at page edges
      ✓ should respect maxLinks parameter (2 ms)
      ✓ should sort links by relevance (1 ms)
      ✓ should detect media type in links
    Link Categorization
      ✓ should categorize links by media type (1 ms)
      ✓ should handle empty links array
    HTML to Text Conversion
      ✓ should convert simple HTML to text (1 ms)
      ✓ should remove script tags
      ✓ should remove style tags (1 ms)
      ✓ should remove navigation elements
      ✓ should remove header and footer
      ✓ should prefer main/article content (1 ms)
      ✓ should handle empty HTML
      ✓ should normalize whitespace
    Strip HTML Helper
      ✓ should strip all HTML tags
      ✓ should normalize whitespace (1 ms)
      ✓ should handle empty input
      ✓ should handle nested tags
    URL Conversion - Relative to Absolute
      ✓ should convert relative links to absolute when baseUrl provided (1 ms)
      ✓ should convert relative image URLs to absolute when baseUrl provided
      ✓ should handle ../ relative paths correctly
      ✓ should leave absolute URLs unchanged (1 ms)
      ✓ should skip anchor-only links
      ✓ should skip javascript: links
      ✓ should work without baseUrl (backward compatibility) (1 ms)
      ✓ should skip data URIs in images (1 ms)

PASS tests/unit/evaluation-parsing.test.js
  Evaluation Response Parsing
    JSON Response Parsing
      ✓ should parse valid JSON with comprehensive=true (1 ms)
      ✓ should parse valid JSON with comprehensive=false
      ✓ should extract JSON from markdown code blocks (1 ms)
      ✓ should extract JSON from text with surrounding content
      ✓ should handle JSON with extra whitespace
    Text Response Parsing - Comprehensive Responses
      ✓ should recognize "yes" as comprehensive
      ✓ should recognize "comprehensive" as comprehensive
      ✓ should recognize "complete" as comprehensive (1 ms)
      ✓ should recognize "sufficient" as comprehensive
      ✓ should recognize "adequate" as comprehensive
      ✓ should recognize "thorough" as comprehensive
      ✓ should recognize "true" as comprehensive (1 ms)
    Text Response Parsing - NOT Comprehensive Responses
      ✓ should recognize "not comprehensive" as NOT comprehensive
      ✓ should recognize "isn't comprehensive" as NOT comprehensive (2 ms)
      ✓ should recognize "is not comprehensive" as NOT comprehensive
      ✓ should recognize "incomplete" as NOT comprehensive (1 ms)
      ✓ should recognize "insufficient" as NOT comprehensive
      ✓ should recognize "too brief" as NOT comprehensive
      ✓ should recognize "too short" as NOT comprehensive
      ✓ should recognize "lacks detail" as NOT comprehensive (1 ms)
      ✓ should recognize "missing information" as NOT comprehensive
      ✓ should recognize standalone "no" as NOT comprehensive
      ✓ should recognize "false" as NOT comprehensive (1 ms)
      ✓ should recognize "not enough" as NOT comprehensive
      ✓ should recognize "not sufficient" as NOT comprehensive
      ✓ should recognize "not complete" as NOT comprehensive (1 ms)
    Edge Cases and Gemini-Specific Formats
      ✓ should NOT match "no" in words like "know"
      ✓ should handle case variations
      ✓ should prioritize negative over positive when both present
      ✓ should handle responses with extra punctuation (1 ms)
      ✓ should handle multi-line responses
      ✓ should assume comprehensive for ambiguous responses
      ✓ should handle empty responses
      ✓ should handle responses with only whitespace
      ✓ should handle Gemini descriptive text format
      ✓ should handle Gemini negative descriptive format
    Invalid JSON Handling
      ✓ should fall back to text parsing for malformed JSON (1 ms)
      ✓ should handle partial JSON

PASS tests/unit/guardrails-factory.test.js
  Guardrails Factory
    createGuardrailValidator
      ✓ should return null when config is null (1 ms)
      ✓ should return null when config.enabled is false (1 ms)
      ✓ should throw error when no API key found for provider (7 ms)
      ✓ should create validator with context API key (1 ms)
      ✓ should create validator with indexed env var API key
    Validator Methods
      validateInput
        ✓ should validate safe input (1 ms)
        ✓ should detect unsafe input (3 ms)
        ✓ should handle JSON wrapped in markdown code blocks (1 ms)
        ✓ should fail safe on API error (1 ms)
        ✓ should fail safe on JSON parse error (1 ms)
      validateOutput
        ✓ should validate safe output (2 ms)
        ✓ should detect unsafe output (1 ms)
        ✓ should fail safe on error
    Multiple Provider Support
      ✓ should work with OpenAI provider (1 ms)
      ✓ should work with Anthropic provider (1 ms)
      ✓ should work with Gemini provider
    Context Priority
      ✓ should prefer context key over indexed env var (1 ms)

PASS tests/unit/providers/provider-streaming.test.js
  Provider Streaming
    Basic Streaming
      ✓ should stream simple chunks (2 ms)
      ✓ should handle empty chunks
      ✓ should handle multiple choices in chunks (1 ms)
      ✓ should return rate limits after streaming (1 ms)
    Chunk Types
      ✓ should handle content chunks (1 ms)
      ✓ should handle role chunks
      ✓ should handle tool call chunks (1 ms)
      ✓ should handle finish reason chunks
      ✓ should handle mixed chunk content (3 ms)
    Stream Error Handling
      ✓ should handle stream errors (5 ms)
      ✓ should handle rate limit errors during streaming (1 ms)
      ✓ should handle network errors during streaming
    Stream Callback
      ✓ should call callback for each chunk (1 ms)
      ✓ should pass complete chunk data to callback (1 ms)
      ✓ should handle callback errors gracefully
    Stream Options
      ✓ should pass stream option in request body (1 ms)
      ✓ should default stream to false
      ✓ should include other options with stream
    Real Provider Streaming
      ✓ should handle OpenAI streaming response format (1 ms)
      ✓ should handle Groq streaming response format
    Stream Performance
      ✓ should handle rapid chunks (1 ms)
      ✓ should handle large chunks

PASS tests/unit/todos-manager.test.js
  TodosManager
    initialization
      ✓ should start with empty state (1 ms)
      ✓ should not emit events on initialization
    add()
      ✓ should add todos and activate first as current (3 ms)
      ✓ should emit todos_updated and todos_current events
      ✓ should handle empty array gracefully (1 ms)
      ✓ should filter out empty or whitespace-only descriptions
      ✓ should not activate current if one already exists (1 ms)
      ✓ should assign sequential IDs
    delete()
      ✓ should delete todos by id (1 ms)
      ✓ should delete todos by exact description
      ✓ should emit todos_updated and todos_current events (1 ms)
      ✓ should reactivate current if current item is deleted
      ✓ should handle empty delete array (1 ms)
      ✓ should handle non-existent ids gracefully
    completeCurrent()
      ✓ should mark current as done and advance to next (1 ms)
      ✓ should emit todos_updated and todos_current events
      ✓ should handle completing last todo (2 ms)
      ✓ should do nothing if no current todo
    hasPending()
      ✓ should return true when there are pending todos (1 ms)
      ✓ should return true when there is a current todo
      ✓ should return false when all todos are done
      ✓ should return false when there are no todos (1 ms)
    getCurrent()
      ✓ should return current todo
      ✓ should return null when no current todo (1 ms)
    clear()
      ✓ should clear all todos
      ✓ should emit todos_updated event
      ✓ should reset ID counter (1 ms)
    event emission
      ✓ should handle writeEvent being null
      ✓ should handle writeEvent throwing errors
    state immutability
      ✓ should return copies of items array (1 ms)
      ✓ should not allow mutation of returned state

PASS tests/todos-manager.test.js
  TodosManager
    constructor
      ✓ initializes with empty state (1 ms)
      ✓ stores writeEvent callback (1 ms)
    getState
      ✓ returns correct state with no todos
      ✓ returns correct state with pending todos (1 ms)
      ✓ returns copies of items to prevent mutation
      ✓ calculates remaining count correctly (1 ms)
    add
      ✓ adds single todo
      ✓ adds multiple todos (1 ms)
      ✓ sets first todo as current
      ✓ preserves current todo when adding more
      ✓ auto-increments IDs (1 ms)
      ✓ trims whitespace from descriptions
      ✓ filters out empty descriptions
      ✓ emits todos_updated event (1 ms)
      ✓ emits todos_current event
      ✓ handles non-array input gracefully (1 ms)
      ✓ handles null/undefined input
    delete
      ✓ deletes todo by id (1 ms)
      ✓ deletes todo by description
      ✓ deletes multiple todos (1 ms)
      ✓ re-activates current if current is deleted
      ✓ sets next pending as current when current deleted (1 ms)
      ✓ handles deleting non-existent todo
      ✓ handles deleting by non-existent id (1 ms)
      ✓ emits events after deletion
      ✓ handles non-array input gracefully (1 ms)
      ✓ converts numeric ids to strings for comparison
    completeCurrent
      ✓ marks current as done (1 ms)
      ✓ advances to next pending
      ✓ handles completing last todo
      ✓ handles completing when no current exists (1 ms)
      ✓ emits events after completion
      ✓ updates remaining count correctly (1 ms)
    hasPending
      ✓ returns true with pending todos
      ✓ returns true with current todo (1 ms)
      ✓ returns false when all done
      ✓ returns false with no todos
    getCurrent
      ✓ returns current todo (1 ms)
      ✓ returns null when no current
      ✓ returns null when all done
    clear
      ✓ removes all todos (1 ms)
      ✓ resets nextId counter
      ✓ emits todos_updated event (1 ms)
    SSE event emission
      ✓ handles missing writeEvent gracefully
      ✓ handles writeEvent errors gracefully (1 ms)
      ✓ emits events in correct order for add (1 ms)
      ✓ includes correct data in todos_updated event
      ✓ includes correct data in todos_current event (1 ms)
    edge cases
      ✓ handles adding todos after all completed
      ✓ handles mixed add and delete operations (1 ms)
      ✓ maintains consistent state through multiple operations
      ✓ handles very long descriptions
      ✓ handles special characters in descriptions
      ✓ handles Unicode characters
    integration scenarios
      ✓ simulates full todo workflow (1 ms)
      ✓ simulates auto-progression with assessor

PASS tests/unit/model-categorizer.test.js
  Model Categorization
    categorizeModel
      reasoning models
        ✓ should categorize o1-preview as reasoning (1 ms)
        ✓ should categorize o1-mini as reasoning
        ✓ should categorize deepseek-reasoner as reasoning (1 ms)
        ✓ should categorize QwQ models as reasoning
      large models
        ✓ should categorize llama-3.3-70b as large
        ✓ should categorize llama-3.3-70b as large (1 ms)
        ✓ should categorize llama-405b as large
        ✓ should categorize mixtral-8x22b as large
        ✓ should categorize gpt-4 as large
        ✓ should categorize gpt-4-turbo as large (1 ms)
        ✓ should categorize qwen-72b as large
        ✓ should categorize claude-3-opus as large
        ✓ should categorize gemini-pro as large (1 ms)
      small models
        ✓ should categorize llama-3.1-8b as small
        ✓ should categorize mixtral-8x7b as small
        ✓ should categorize gemma as small
        ✓ should categorize gpt-4o-mini as small (1 ms)
        ✓ should categorize gpt-3.5-turbo as small
        ✓ should categorize claude-3-haiku as small
        ✓ should categorize gemini-flash as small (1 ms)
        ✓ should categorize qwen-32b as small
      edge cases
        ✓ should default to small for unknown models (2 ms)
        ✓ should default to small for null
        ✓ should default to small for undefined
        ✓ should default to small for empty string (1 ms)
        ✓ should handle mixed case model names
    getModelsByCategory
      ✓ should get all small models
      ✓ should get all large models (1 ms)
      ✓ should get all reasoning models
      ✓ should include provider type in results
      ✓ should include category in results (1 ms)
      ✓ should return empty array for invalid catalog
      ✓ should handle missing models array
    getRecommendedCategory
      ✓ should recommend reasoning for requiresReasoning=true (1 ms)
      ✓ should recommend large for requiresLargeContext=true
      ✓ should recommend large for estimatedTokens > 8000
      ✓ should recommend small for estimatedTokens <= 8000
      ✓ should recommend small by default (1 ms)
      ✓ should prioritize reasoning over large context
      ✓ should prioritize reasoning over token count
    supportsContextWindow
      ✓ should return true when context window is sufficient (1 ms)
      ✓ should return false when required tokens exactly match (due to 20% safety buffer)
      ✓ should return true when required tokens are within safe range
      ✓ should return false when context window is insufficient
      ✓ should return false for null model (1 ms)
      ✓ should return false when contextWindow is missing
    filterByContextWindow
      ✓ should filter models by context window requirement (1 ms)
      ✓ should return all models when requiredTokens is 0 (1 ms)
      ✓ should return all models when requiredTokens is negative
      ✓ should return empty array when no models meet requirement
      ✓ should return all models when requirement is very low (1 ms)
    getModelInfo
      ✓ should get model info with category
      ✓ should find model in any provider
      ✓ should return null for unknown model (1 ms)
      ✓ should return null for invalid inputs
    ModelCategory constants
      ✓ should have correct category values
      ✓ should be defined and accessible (1 ms)
    integration scenarios
      ✓ should find suitable small models for simple request
      ✓ should find suitable large models for complex request
      ✓ should find reasoning models when needed (1 ms)

PASS tests/integration/prompts-integration.test.js
  Prompt System Integration Tests
    Comprehensive Research Prompt
      ✓ should generate valid prompt string (1 ms)
      ✓ should inject current date and time
      ✓ should include all critical tool definitions (1 ms)
      ✓ should emphasize strict parameter requirements
      ✓ should provide guidance on tool usage (2 ms)
      ✓ should specify response quality expectations
      ✓ should include formatting instructions (1 ms)
      ✓ should warn against incorrect tool syntax
      ✓ should provide date calculation guidance
      ✓ should be reasonably concise (1 ms)
    Prompt Consistency and Quality
      ✓ prompts should be deterministic (same output for same input)
      ✓ prompts should not have placeholder text (1 ms)
      ✓ prompts should have proper grammar and punctuation
      ✓ prompts should not have obvious typos
    Prompt Composition and Flow
      ✓ comprehensive prompt should have logical structure (1 ms)
      ✓ should not have excessive repetition
      ✓ should balance specificity with flexibility (1 ms)
    Prompt Length and Structure
      ✓ comprehensive prompt should have reasonable length
      ✓ should handle prompts with code examples gracefully
      ✓ should handle prompts with structured lists (1 ms)

PASS tests/unit/config.test.js
  Configuration Modules
    Token Configuration
      ✓ should export token constants (1 ms)
      ✓ should provide complexity-based token allocation
    Memory Configuration
      ✓ should export memory constants
      ✓ should calculate max content size correctly
    Prompts Configuration
      ✓ should export prompt constants (2 ms)
      ✓ should have reasonable defaults (1 ms)

PASS tests/unit/weighted-scoring.test.js
  Enhanced Weighted Scoring System
    calculateRelevanceScore
      ✓ should give higher scores for exact phrase matches (1 ms)
      ✓ should score authoritative domains higher (1 ms)
      ✓ should reward term frequency
      ✓ should give position bonuses for early term appearances
      ✓ should reward term proximity (1 ms)
      ✓ should penalize suspicious URL patterns
      ✓ should reward complete query coverage (1 ms)
      ✓ should boost DuckDuckGo native scores appropriately
    helper methods
      ✓ calculateTermFrequency should count term occurrences (1 ms)
      ✓ calculatePositionScore should favor early positions
      ✓ calculateProximityScore should reward close terms
      ✓ calculateDomainAuthorityScore should rank domains correctly (1 ms)
      ✓ calculateUrlStructureScore should penalize suspicious patterns (1 ms)

PASS tests/unit/health-checker.test.js
  HealthChecker
    Health Check Initialization
      ✓ should start periodic health checks on initialization (1 ms)
      ✓ should use custom check interval
      ✓ should allow disabling automatic checks
    Provider Health Tracking
      ✓ should track provider availability (6 ms)
      ✓ should decrease availability on consecutive failures (1 ms)
      ✓ should reset consecutive errors on success (1 ms)
    Automatic Health Recovery
      ✓ should gradually recover availability after cooldown period (1 ms)
      ✓ should not recover during cooldown period (1 ms)
      ✓ should cap availability at 1.0
    Error Tracking
      ✓ should track last error details
      ✓ should track error history (3 ms)
      ✓ should limit error history size (1 ms)
    Health Check Status
      ✓ should return healthy status for good provider (1 ms)
      ✓ should return unhealthy status for degraded provider
      ✓ should use custom health threshold (1 ms)
    Availability Scoring
      ✓ should calculate availability score based on error rate (1 ms)
      ✓ should weigh recent errors more heavily
    Lifecycle Management
      ✓ should stop health checks when stopped
      ✓ should allow manual health check execution (1 ms)

PASS tests/unit/model-selector-legacy.test.js
  legacy selectModel
    ✓ avoids previously rate-limited model when selecting fallback (1 ms)

PASS tests/unit/endpoints/static.test.js
  Static File Server Endpoint
    getContentType
      ✓ should return correct MIME type for HTML (1 ms)
      ✓ should return correct MIME type for CSS (1 ms)
      ✓ should return correct MIME type for JavaScript
      ✓ should return correct MIME type for JSON
      ✓ should return correct MIME type for images (2 ms)
      ✓ should return default MIME type for unknown extensions (1 ms)
    readStaticFile
      ✓ should read file from docs directory
      ✓ should default to index.html for root path (1 ms)
      ✓ should reject paths outside docs directory (3 ms)
      ✓ should reject non-existent files (1 ms)
      ✓ should handle read errors (1 ms)
      ✓ should handle nested paths correctly
    handler
      ✓ should serve HTML file (1 ms)
      ✓ should serve binary files with base64 encoding
      ✓ should return 404 for non-existent files
      ✓ should return 404 for paths outside docs directory
      ✓ should include cache headers (1 ms)
      ✓ should include CORS headers

PASS tests/integration/content-optimization-integration.test.js
  Content Optimization Integration Tests
    Max Tokens Optimization
      ✓ should optimize for cost (cheap setting) (1 ms)
      ✓ should optimize for quality (powerful setting)
      ✓ should optimize for speed (fastest setting) (1 ms)
      ✓ should provide balanced defaults
    Request Type Adaptation
      ✓ should allocate appropriate tokens for simple requests
      ✓ should allocate more tokens for complex requests (1 ms)
      ✓ should allocate maximum tokens for reasoning requests
      ✓ should handle tool-heavy requests appropriately
      ✓ should handle creative content generation
    Model Capability Constraints
      ✓ should respect model max output limits (1 ms)
      ✓ should respect context window constraints
      ✓ should handle models with very small context windows
      ✓ should provide safe defaults when model info missing (1 ms)
    Search Result Optimization
      ✓ should optimize search results for cheap setting
      ✓ should allow more results for powerful setting
      ✓ should adapt to request complexity (1 ms)
      ✓ should return reasonable defaults
    Content Length Optimization
      ✓ should optimize content length for cheap setting (1 ms)
      ✓ should allow longer content for powerful setting (1 ms)
      ✓ should adapt to content type
      ✓ should return reasonable defaults (1 ms)
    Optimization Summary
      ✓ should provide comprehensive optimization summary
      ✓ should summarize cheap optimization strategy
      ✓ should summarize powerful optimization strategy (1 ms)
    Optimization Trade-offs
      ✓ cheap vs powerful trade-off for simple requests
      ✓ simple vs complex request trade-off
      ✓ fastest vs powerful trade-off (1 ms)
    Edge Cases and Robustness
      ✓ should handle missing optimization parameter
      ✓ should handle missing request type
      ✓ should handle invalid optimization values (1 ms)
      ✓ should handle very large input tokens
      ✓ should handle negative or zero input tokens
      ✓ should handle models with missing or invalid properties (1 ms)
    Optimization Consistency
      ✓ should produce consistent results for same inputs
      ✓ should scale predictably with optimization levels
      ✓ should scale predictably with request complexity (1 ms)

PASS tests/unit/credential-pool.test.js
  Credential Pool
    loadEnvironmentProviders
      ✓ should load provider from environment (2 ms)
      ✓ should load multiple providers
      ✓ should skip indices with missing type or key (1 ms)
      ✓ should handle gaps in provider indices
      ✓ should load optional endpoint (1 ms)
      ✓ should load optional model name
      ✓ should load priority settings (1 ms)
      ✓ should use default priority 100 when not specified
      ✓ should return empty array when no providers configured (1 ms)
    buildProviderPool
      ✓ should build pool with user providers only (unauthorized)
      ✓ should build pool with user + environment providers (authorized) (3 ms)
      ✓ should skip invalid user providers (1 ms)
      ✓ should handle empty user providers
    hasAvailableProviders
      ✓ should return true when user has valid providers (1 ms)
      ✓ should return false when user has no valid providers (unauthorized)
      ✓ should return true when authorized with environment providers (1 ms)
      ✓ should filter out invalid user providers
    Security Tests
      ✓ should not expose API keys in logs (1 ms)
      ✓ should handle malformed priority values
      ✓ should mark server-side keys correctly (1 ms)

PASS tests/unit/prompts.test.js
  config/prompts
    ✓ includes JSON tool call enforcement rule (1 ms)

PASS tests/unit/token-calculator.test.js
  Token Calculator
    detectModelFamily
      ✓ should detect GPT-4 family (1 ms)
      ✓ should detect GPT-3.5 family
      ✓ should detect Llama family
      ✓ should detect Mixtral family (1 ms)
      ✓ should detect Gemma family
      ✓ should detect Qwen family
      ✓ should detect Claude family
      ✓ should detect Gemini family (1 ms)
      ✓ should return default for unknown models
      ✓ should be case insensitive
    estimateMessageTokens
      ✓ should estimate tokens for simple message (1 ms)
      ✓ should include message overhead
      ✓ should estimate tokens for long message
      ✓ should handle multi-modal content (1 ms)
      ✓ should return overhead for empty content
      ✓ should return 0 for null/undefined message (1 ms)
      ✓ should use different overhead for different models
    estimateMessagesTokens
      ✓ should estimate tokens for message array
      ✓ should include conversation overhead (1 ms)
      ✓ should return 0 for empty array (2 ms)
      ✓ should return 0 for invalid input
      ✓ should scale linearly with message count
    estimateToolTokens
      ✓ should estimate tokens for tool definitions (1 ms)
      ✓ should scale with number of tools
      ✓ should return 0 for empty array
      ✓ should return 0 for invalid input
    estimateInputTokens
      ✓ should estimate total input tokens (1 ms)
      ✓ should sum messages and tools
      ✓ should handle missing options
    estimateOutputTokens
      ✓ should estimate output tokens for simple requests (1 ms)
      ✓ should estimate output tokens for complex requests
      ✓ should estimate output tokens for reasoning requests
      ✓ should use default rate for unknown request types
      ✓ should handle missing options
    calculateCost
      ✓ should calculate cost correctly
      ✓ should return 0 for free models
      ✓ should handle large token counts (1 ms)
      ✓ should handle different input/output costs
      ✓ should handle missing options
    estimateRequestCost
      ✓ should return complete cost breakdown (1 ms)
      ✓ should estimate cost for free tier correctly
      ✓ should handle complex requests with tools
    fitsInContextWindow
      ✓ should return true when request fits (1 ms)
      ✓ should return true when exactly fits
      ✓ should return false when request exceeds window (1 ms)
      ✓ should handle edge cases (1 ms)
    getRecommendedMaxTokens
      ✓ should return requested tokens when plenty of space
      ✓ should limit tokens when approaching context window
      ✓ should return 0 when context window exceeded
      ✓ should account for safety margin (1 ms)
      ✓ should use default max_tokens when not specified
    integration scenarios
      ✓ should estimate cost for typical chat request
      ✓ should estimate cost for tool-using request (1 ms)
      ✓ should check if large request fits in small context window

PASS tests/unit/backoff-strategy.test.js
  BackoffStrategy
    Exponential Backoff
      ✓ should calculate delay with exponential growth (1 ms)
      ✓ should use base delay for attempt 0
      ✓ should double exponentially
      ✓ should cap at max delay
      ✓ should use custom base delay
    Jitter Application
      ✓ should add jitter to prevent thundering herd
      ✓ should keep jitter within ±25% range (7 ms)
    Retry-After Header Parsing
      ✓ should parse numeric retry-after (seconds) (1 ms)
      ✓ should parse string retry-after (seconds)
      ✓ should parse HTTP date format
      ✓ should handle past dates (1 ms)
      ✓ should handle invalid retry-after
      ✓ should handle missing retry-after
      ✓ should handle undefined retry-after (1 ms)
    Edge Cases
      ✓ should handle zero base delay
      ✓ should handle very large attempt numbers
      ✓ should handle negative attempt numbers (1 ms)
      ✓ should handle very small max delay
    Realistic Scenarios
      ✓ should provide reasonable delays for typical retry sequence (1 ms)
      ✓ should respect retry-after over exponential backoff

FAIL tests/unit/memory-tracker.test.js
  MemoryTracker
    getMemoryUsage
      ✓ should return memory usage statistics (1 ms)
      ✓ should track content size (2 ms)
    checkMemoryLimit
      ✕ should allow small content additions (1 ms)
      ✓ should reject very large content additions
      ✓ should provide detailed size information (1 ms)
    addContentSize
      ✓ should track accumulated content size
    getMemorySummary
      ✓ should return formatted summary string (1 ms)
  TokenAwareMemoryTracker
    estimateTokens
      ✓ should estimate tokens from text (4 chars = 1 token)
      ✓ should handle empty strings
      ✓ should handle long text (1 ms)
    canAddContent
      ✓ should allow content within token limit (1 ms)
      ✓ should reject content exceeding token limit
      ✓ should track accumulated tokens (1 ms)
    addContent
      ✓ should add content and track tokens (1 ms)
      ✓ should truncate content exceeding token limit
      ✓ should handle content at exact token limit
    cleanContent
      ✓ should remove extra whitespace (1 ms)
      ✓ should handle null content
      ✓ should handle undefined content (1 ms)
      ✓ should handle non-string content (1 ms)
      ✓ should trim leading and trailing whitespace
    Integration Tests
      ✓ should manage content lifecycle (1 ms)
      ✓ should prevent memory overflow

  ● MemoryTracker › checkMemoryLimit › should allow small content additions

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      41 |             const result = tracker.checkMemoryLimit(1024); // 1KB
      42 |             
    > 43 |             expect(result.allowed).toBe(true);
         |                                    ^
      44 |             expect(result.reason).toBe('OK');
      45 |         });
      46 |

      at Object.toBe (tests/unit/memory-tracker.test.js:43:36)

PASS tests/unit/performance-tracking.test.js
  Performance Tracking
    ModelRateLimit - Performance Recording
      ✓ should initialize with empty performance history (1 ms)
      ✓ should record performance metrics
      ✓ should limit performance history to 100 entries (1 ms)
      ✓ should calculate average performance from last 20 requests (1 ms)
      ✓ should return null average when no performance data
      ✓ should handle partial performance data (<20 samples)
    RateLimitTracker - Performance Methods
      ✓ should record performance via tracker (1 ms)
      ✓ should return null for unknown model (1 ms)
      ✓ should track performance across multiple models
    Speed Optimization - sortBySpeed
      ✓ should sort models by historical TTFT (ascending) (1 ms)
      ✓ should handle models without performance data
      ✓ should return empty array for empty input (1 ms)
    Performance Metrics Validation
      ✓ should handle missing timestamp gracefully
      ✓ should ignore invalid performance metrics (1 ms)
    Real-World Performance Scenarios
      ✓ should reflect Groq speed advantage
      ✓ should track performance degradation over time (1 ms)

PASS tests/unit/utils.test.js
  Utility Modules
    Error Handling Utils
      isQuotaLimitError
        ✓ should detect quota limit errors (1 ms)
        ✓ should not detect non-quota errors (1 ms)
      parseWaitTimeFromMessage
        ✓ should parse seconds from error messages (1 ms)
        ✓ should parse milliseconds from error messages
        ✓ should parse minutes from error messages (1 ms)
        ✓ should return default for unparseable messages
    Token Estimation Utils
      estimateTokenCount
        ✓ should estimate tokens from text length (1 ms)
      safeParseJson
        ✓ should parse valid JSON (1 ms)
        ✓ should return fallback for invalid JSON (2 ms)
      truncateText
        ✓ should truncate long text

PASS tests/unit/health-tracking.test.js
  Health Tracking
    ModelRateLimit - Health Score Calculation
      ✓ should initialize with perfect health
      ✓ should record successful requests
      ✓ should record errors and reduce health score (1 ms)
      ✓ should mark unhealthy after 3 consecutive errors
      ✓ should reset consecutive errors on success
      ✓ should mark unhealthy when health score < 30 (1 ms)
      ✓ should handle zero requests gracefully (1 ms)
      ✓ should cap error penalty at 30 points
      ✓ should recover health score after errors clear (1 ms)
    RateLimitTracker - Health Methods
      ✓ should record success via tracker
      ✓ should record error via tracker (1 ms)
      ✓ should return 100 for unknown model
      ✓ should track health across multiple models
    Health-Based Filtering - filterByHealth
      ✓ should filter out unhealthy models (1 ms)
      ✓ should keep models with no history (assume healthy)
      ✓ should return empty array if all models unhealthy
      ✓ should handle empty input (1 ms)
      ✓ should preserve model order after filtering
    Header Parsing - updateFromHeaders
      ✓ should parse standard x-ratelimit-* headers (1 ms)
      ✓ should parse Google x-goog-quota-* headers
      ✓ should store lastResponseHeaders for debugging
      ✓ should handle missing headers gracefully (1 ms)
    Real-World Health Scenarios
      ✓ should handle transient errors
      ✓ should detect persistent failures (1 ms)
      ✓ should track recovery after outage (1 ms)
      ✓ should handle rate limit 429 as error
    Integration - Performance + Health
      ✓ should track both performance and health independently

PASS tests/integration/quiz-analytics.test.js
  Quiz Analytics
    Data Collection
      ✓ should track quiz completion with detailed analytics
      ✓ should extract topics from quiz content (1 ms)
      ✓ should track question-level performance
    Study Streak Calculation
      ✓ should calculate consecutive day streak
      ✓ should reset streak if day missed (1 ms)
    Topic Performance Aggregation
      ✓ should calculate average score per topic
      ✓ should identify performance trend (improving/declining/stable)
    Achievement System
      ✓ should unlock achievements based on progress
      ✓ should track progress towards locked achievements
    Question Insights
      ✓ should identify most difficult questions (1 ms)
    CSV Export
      ✓ should export quiz data to CSV format
    Dashboard Rendering
      ✓ should display overview statistics correctly (1 ms)
      ✓ should format time display correctly

PASS tests/integration/aggressive-caching.test.js
  Aggressive Caching
    Cache Service
      ✓ should export cache singleton
      ✓ should hash messages consistently (1 ms)
      ✓ should hash different messages differently
    Cache Integration
      ✓ should cache LLM responses
      ✓ should cache search results (1 ms)
      ✓ should respect TTL expiration
      ✓ should enforce storage limits with LRU eviction
    API Integration
      ✓ should check cache before API calls (1 ms)
      ✓ should cache responses asynchronously
    Cache Management
      ✓ should clear all cache entries
      ✓ should enable/disable caching (1 ms)
      ✓ should provide cache statistics

PASS tests/unit/services.test.js
  Service Modules
    Tracking Service
      trackToolCall
        ✓ should create tool call tracking record
        ✓ should handle minimal tool call data (2 ms)
      trackLLMCall
        ✓ should create LLM call tracking record
        ✓ should handle response with text field (1 ms)

PASS tests/unit/pricing-display.test.js
  Pricing Display Functions
    calculateCostFromLlmApiCalls
      ✓ handles empty array (1 ms)
      ✓ handles null/undefined input
      ✓ calculates GPT-4o cost correctly
      ✓ calculates GPT-4o-mini cost correctly (1 ms)
      ✓ free models return $0
      ✓ Groq models return $0
      ✓ aggregates costs from multiple calls (1 ms)
      ✓ handles mixed free and paid models
      ✓ handles missing usage data
      ✓ handles missing model
      ✓ handles unknown model (defaults to $0) (1 ms)
      ✓ handles zero tokens
      ✓ handles large token counts (1 ms)
    formatCostDisplay
      ✓ formats zero cost
      ✓ formats very small costs
      ✓ formats small costs with 4 decimals (1 ms)
      ✓ formats medium costs with 3 decimals
      ✓ formats large costs with 2 decimals
      ✓ handles negative costs (edge case) (1 ms)
      ✓ handles very large costs
    Integration Tests
      ✓ real-world scenario: multiple GPT-4o calls
      ✓ real-world scenario: free models only (1 ms)
      ✓ real-world scenario: mixed free and paid

PASS tests/unit/guardrails-config.test.js
  Guardrails Auto-Detection
    Disabled State
      ✓ should return null when ENABLE_GUARDRAILS is not set (1 ms)
      ✓ should return null when ENABLE_GUARDRAILS is false (2 ms)
      ✓ should return null when ENABLE_GUARDRAILS is true but no providers available
    Provider Priority - Context Keys
      ✓ should prefer groq-free when groqApiKey is provided in context
      ✓ should use gemini-free when geminiApiKey is provided and groq is not available (1 ms)
      ✓ should use together when togetherApiKey is provided and free tiers not available
      ✓ should use openai when openaiApiKey is provided and higher priority providers not available
      ✓ should prefer groq-free over other providers when multiple keys provided (1 ms)
      ✓ should prefer gemini-free over paid providers when groq not available
    Provider Priority - Indexed Env Vars
      ✓ should use groq-free from indexed provider env vars (1 ms)
      ✓ should use gemini-free from indexed provider env vars
      ✓ should skip providers without API keys in indexed format (1 ms)
    Context Overrides Env Vars
      ✓ should prefer context keys over indexed env vars (1 ms)
    Configuration Structure
      ✓ should return complete config structure (1 ms)
      ✓ should set enabled to true (1 ms)
      ✓ should default strictness to moderate (1 ms)
      ✓ should have same model for input and output by default
    Edge Cases
      ✓ should handle empty context object when indexed provider available (1 ms)
      ✓ should handle undefined context when indexed provider available
      ✓ should handle context with null values (1 ms)
      ✓ should handle whitespace-only API keys in indexed providers
    Groq Paid Tier
      ✓ should use groq paid tier when groq-free not available (1 ms)
    Model Selection
      ✓ should select fast small model for groq-free
      ✓ should select flash model for gemini-free (1 ms)
      ✓ should select mini model for openai

PASS tests/unit/circuit-breaker.test.js
  CircuitBreaker
    Circuit States
      ✓ should start in CLOSED state (2 ms)
      ✓ should transition to OPEN after failure threshold
      ✓ should transition to HALF_OPEN after timeout (1 ms)
      ✓ should close circuit on success in HALF_OPEN state
      ✓ should reopen circuit on failure in HALF_OPEN state (1 ms)
    Failure Tracking
      ✓ should track consecutive failures
      ✓ should reset failures on success (1 ms)
      ✓ should track last failure timestamp
    Timeout Configuration
      ✓ should use custom failure threshold
      ✓ should use custom timeout period
    Multiple Providers
      ✓ should track state independently per provider
      ✓ should get all circuit states (1 ms)
    State Management
      ✓ should reset circuit state (1 ms)
      ✓ should reset all circuits
    Edge Cases
      ✓ should handle rapid successive calls (1 ms)
      ✓ should handle state check without prior interaction
      ✓ should handle time going backwards

PASS tests/unit/auth.test.js
  Authentication
    getAllowedEmails
      ✓ should return empty array when no emails configured (1 ms)
      ✓ should parse single email (2 ms)
      ✓ should parse multiple emails
      ✓ should trim whitespace from emails (1 ms)
    verifyGoogleToken
      ✓ should be skipped when google-auth-library is not available

PASS tests/unit/error-classifier.test.js
  ErrorClassifier
    Error Type Classification
      ✓ should classify 429 as RATE_LIMIT
      ✓ should classify 401 as AUTH
      ✓ should classify 403 as FORBIDDEN
      ✓ should classify 5xx as SERVER_ERROR (1 ms)
      ✓ should classify 4xx as CLIENT_ERROR
      ✓ should classify network errors
      ✓ should classify unknown errors
    Retryability Assessment
      ✓ should mark rate limit errors as retryable
      ✓ should mark server errors as retryable (1 ms)
      ✓ should mark network errors as retryable
      ✓ should mark auth errors as non-retryable (2 ms)
      ✓ should mark client errors as non-retryable
    Severity Assessment
      ✓ should assign LOW severity to rate limit errors
      ✓ should assign MEDIUM severity to server errors (1 ms)
      ✓ should assign HIGH severity to auth errors
      ✓ should assign MEDIUM severity to unknown errors
    Suggested Actions
      ✓ should suggest switching provider for rate limits (1 ms)
      ✓ should suggest checking API key for auth errors
      ✓ should suggest retry with backoff for server errors
      ✓ should suggest contacting support for unknown errors (1 ms)
    Complete Classification
      ✓ should return all classification fields
      ✓ should handle Error objects (1 ms)
      ✓ should handle errors with additional metadata

PASS tests/unit/pricing-accuracy.test.js
  Pricing Accuracy Tests
    ✓ Backend and frontend pricing should be loaded (1 ms)
    ✓ Embedding models should have zero output cost (2 ms)
    ✓ All embedding models should be present in both pricing databases
    ○ skipped All backend models should exist in frontend with matching prices
    ○ skipped Groq models should be free ($0 per million tokens)
    ○ skipped Gemini free tier models should be free ($0 per million tokens)
    ○ skipped Together AI free tier models (with -Free suffix) should be free

PASS tests/unit/model-config.test.js
  Model Configuration
    Default Model Selection
      ✓ should use openai/gpt-oss-120b as default model
      ✓ should not use deprecated or problematic models as default (1 ms)
    Model Availability
      ✓ should have openai/gpt-oss-120b in Groq provider list
      ✓ should have rate limit configuration for openai/gpt-oss-120b
      ✓ should have pricing information for openai/gpt-oss-120b (1 ms)
    Function Calling Support
      ✓ should document why openai/gpt-oss-120b is the best choice
      ✓ should prefer OpenAI format over Anthropic format
    Model Fallback Chain
      ✓ should have fallback models available (1 ms)
    Configuration Consistency
      ✓ should use production-ready model for chat
      ✓ should have model documented in MODEL_RECOMMENDATION.md
    No Content Cleaning Required
      ✓ should not need cleanLLMContent function with better model (1 ms)
      ✓ should document why content cleaning was removed
  Integration with Backend
    ✓ should pass correct model to backend API
    ✓ should use Groq API endpoint (3 ms)
  Backward Compatibility
    ✓ should still support llama-3.3 if user has it configured (1 ms)
    ✓ should handle user settings migration

FAIL tests/integration/user-billing.test.js
  User Billing Sheet Service
    getOrCreateBillingSheet
      ○ skipped should create a new billing sheet if none exists
      ○ skipped should return existing billing sheet if found
    logToBillingSheet
      ○ skipped should log transaction data to billing sheet
      ○ skipped should handle logging errors gracefully
    readBillingData
      ○ skipped should read all billing data without filters
      ○ skipped should filter by date range
      ○ skipped should filter by type
      ○ skipped should filter by provider
      ○ skipped should combine multiple filters
    clearBillingData
      ○ skipped should clear all billing data
      ○ skipped should clear data by provider
      ○ skipped should clear data by date range
      ○ skipped should reject invalid clear mode
  Billing Endpoint
    GET /billing
      ✕ should return billing data with totals
      ✕ should filter by query parameters (1 ms)
      ✕ should require authentication
    DELETE /billing/clear
      ✕ should clear all data (1 ms)
      ✕ should clear data by provider
      ✕ should clear data by date range (1 ms)
      ✕ should reject invalid mode
      ✕ should require mode parameter
  End-to-End Billing Flow
    ✕ should complete full billing lifecycle (1 ms)

  ● Billing Endpoint › GET /billing › should return billing data with totals

    TypeError: Cannot read properties of undefined (reading 'handler')

      333 |       };
      334 |
    > 335 |       const response = await billingEndpoint.handler(
          |                                              ^
      336 |         event,
      337 |         mockResponseStream,
      338 |         {}

      at Object.handler (tests/integration/user-billing.test.js:335:46)

  ● Billing Endpoint › GET /billing › should filter by query parameters

    TypeError: Cannot read properties of undefined (reading 'handler')

      364 |       };
      365 |
    > 366 |       const response = await billingEndpoint.handler(
          |                                              ^
      367 |         event,
      368 |         mockResponseStream,
      369 |         {}

      at Object.handler (tests/integration/user-billing.test.js:366:46)

  ● Billing Endpoint › GET /billing › should require authentication

    TypeError: Cannot read properties of undefined (reading 'handler')

      385 |       };
      386 |
    > 387 |       const response = await billingEndpoint.handler(
          |                                              ^
      388 |         event,
      389 |         mockResponseStream,
      390 |         {}

      at Object.handler (tests/integration/user-billing.test.js:387:46)

  ● Billing Endpoint › DELETE /billing/clear › should clear all data

    TypeError: Cannot read properties of undefined (reading 'handler')

      411 |       };
      412 |
    > 413 |       const response = await billingEndpoint.handler(
          |                                              ^
      414 |         event,
      415 |         mockResponseStream,
      416 |         {}

      at Object.handler (tests/integration/user-billing.test.js:413:46)

  ● Billing Endpoint › DELETE /billing/clear › should clear data by provider

    TypeError: Cannot read properties of undefined (reading 'handler')

      437 |       };
      438 |
    > 439 |       const response = await billingEndpoint.handler(
          |                                              ^
      440 |         event,
      441 |         mockResponseStream,
      442 |         {}

      at Object.handler (tests/integration/user-billing.test.js:439:46)

  ● Billing Endpoint › DELETE /billing/clear › should clear data by date range

    TypeError: Cannot read properties of undefined (reading 'handler')

      462 |       };
      463 |
    > 464 |       const response = await billingEndpoint.handler(
          |                                              ^
      465 |         event,
      466 |         mockResponseStream,
      467 |         {}

      at Object.handler (tests/integration/user-billing.test.js:464:46)

  ● Billing Endpoint › DELETE /billing/clear › should reject invalid mode

    TypeError: Cannot read properties of undefined (reading 'handler')

      485 |       };
      486 |
    > 487 |       const response = await billingEndpoint.handler(
          |                                              ^
      488 |         event,
      489 |         mockResponseStream,
      490 |         {}

      at Object.handler (tests/integration/user-billing.test.js:487:46)

  ● Billing Endpoint › DELETE /billing/clear › should require mode parameter

    TypeError: Cannot read properties of undefined (reading 'handler')

      507 |       };
      508 |
    > 509 |       const response = await billingEndpoint.handler(
          |                                              ^
      510 |         event,
      511 |         mockResponseStream,
      512 |         {}

      at Object.handler (tests/integration/user-billing.test.js:509:46)

  ● End-to-End Billing Flow › should complete full billing lifecycle

    TypeError: Cannot read properties of undefined (reading 'getOrCreateBillingSheet')

      529 |
      530 |     // 1. Create/Get billing sheet
    > 531 |     const sheet = await userBillingSheet.getOrCreateBillingSheet(
          |                                          ^
      532 |       mockUserEmail,
      533 |       mockAccessToken
      534 |     );

      at Object.getOrCreateBillingSheet (tests/integration/user-billing.test.js:531:42)

